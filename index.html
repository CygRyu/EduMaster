<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMaster Tutoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4F4FC9',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: {
                            100: '#D1D5DB',
                            200: '#9CA3AF',
                            300: '#6B7280',
                            400: '#4B5563',
                            500: '#374151',
                            600: '#2D3748',
                            700: '#1F2937',
                            800: '#1A202C',
                            900: '#171923',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .notification-dot {
            top: 3px;
            right: 3px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-panel {
            background: rgba(26, 32, 44, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }

        .dark .chart-container canvas {
            filter: invert(0.85) hue-rotate(180deg);
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .session-progress-bar {
            transition: width 0.5s linear;
        }

        .star-rating {
            color: #f59e0b;
        }

        .shake-animation {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .save-indicator {
            position: fixed;
            bottom: 70px;
            right: 20px;
            padding: 8px 16px;
            background-color: rgba(93, 92, 222, 0.9);
            color: white;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-white dark:bg-dark-900 text-gray-800 dark:text-white min-h-screen">
    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <header class="mb-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div class="flex items-center mb-4 md:mb-0">
                    <span class="text-primary dark:text-primary text-3xl font-bold mr-2">
                        <i class="fas fa-book"></i>
                    </span>
                    <h1 class="text-2xl font-bold">EduMaster Tutoring</h1>
                    <span class="ml-4 bg-primary text-white px-2 py-1 rounded text-xs">BETA</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="bg-gray-100 dark:bg-dark-700 rounded-full px-4 py-2 flex items-center shadow-sm">
                        <i class="fas fa-dollar-sign text-success mr-2"></i>
                        <span id="company-capital" class="font-semibold">$30,000.00</span>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 rounded-full px-4 py-2 flex items-center shadow-sm">
                        <i class="fas fa-calendar-day text-primary mr-2"></i>
                        <span id="current-time" class="font-semibold">--:--:--</span>
                    </div>
                    <div class="relative">
                        <button id="notifications-btn" class="bg-gray-100 dark:bg-dark-700 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-dark-600 shadow-sm">
                            <i class="fas fa-bell"></i>
                            <span id="notification-dot" class="notification-dot absolute h-2 w-2 bg-red-500 rounded-full hidden"></span>
                        </button>
                    </div>
                    <div>
                        <button id="save-export-btn" class="bg-gray-100 dark:bg-dark-700 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-dark-600 shadow-sm">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                    <div>
                        <button id="manual-save-btn" class="bg-primary text-white p-2 rounded-full hover:bg-secondary shadow-sm">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="notifications-panel" class="mb-6 bg-white dark:bg-dark-800 rounded-xl shadow-md p-4 hidden animate-fadeIn">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-semibold">Notifications</h2>
                <button id="close-notifications" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="notifications-list" class="max-h-48 overflow-y-auto scrollbar-hide">
                <!-- Notifications will be inserted here -->
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md mb-6">
            <div class="flex overflow-x-auto scrollbar-hide border-b border-gray-200 dark:border-dark-600">
                <button data-tab="dashboard" class="tab-btn px-6 py-4 text-primary border-b-2 border-primary font-medium">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button data-tab="students" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-user-graduate mr-2"></i>Students
                    <span id="students-count" class="ml-2 bg-gray-200 dark:bg-dark-700 rounded-full text-xs px-2 py-0.5">0</span>
                </button>
                <button data-tab="teachers" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>Teachers
                    <span id="teachers-count" class="ml-2 bg-gray-200 dark:bg-dark-700 rounded-full text-xs px-2 py-0.5">0</span>
                </button>
                <button data-tab="active" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-users-class mr-2"></i>Active Sessions
                    <span id="active-count" class="ml-2 bg-gray-200 dark:bg-dark-700 rounded-full text-xs px-2 py-0.5">0</span>
                </button>
                <button data-tab="company" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-building mr-2"></i>Company
                </button>
                <button data-tab="marketing" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-ad mr-2"></i>Marketing
                </button>
                <button data-tab="upgrades" class="tab-btn px-6 py-4 text-gray-500 dark:text-gray-400 hover:text-primary hover:dark:text-primary font-medium">
                    <i class="fas fa-arrow-up mr-2"></i>Upgrades
                </button>
            </div>
        </div>

        <!-- Tab content containers -->
        <div id="dashboard-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-gray-500 dark:text-gray-400 text-sm">Daily Earnings</h3>
                            <p class="text-2xl font-bold">$<span id="daily-earnings">0.00</span></p>
                        </div>
                        <span class="text-success bg-success bg-opacity-10 p-2 rounded-lg">
                            <i class="fas fa-chart-line"></i>
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span id="earnings-change" class="text-success mr-2">
                            <i class="fas fa-arrow-up"></i> 0%
                        </span>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">vs yesterday</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-gray-500 dark:text-gray-400 text-sm">Sessions Completed</h3>
                            <p class="text-2xl font-bold"><span id="sessions-completed">0</span>/<span id="sessions-quota">10</span></p>
                        </div>
                        <span class="text-primary bg-primary bg-opacity-10 p-2 rounded-lg">
                            <i class="fas fa-graduation-cap"></i>
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                        <div id="quota-progress-bar" class="bg-primary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <span class="text-gray-500 dark:text-gray-400 text-sm">Daily quota progress</span>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-gray-500 dark:text-gray-400 text-sm">Company Reputation</h3>
                            <p class="text-2xl font-bold"><span id="company-reputation-display">0</span>/5</p>
                        </div>
                        <span class="text-yellow-500 bg-yellow-500 bg-opacity-10 p-2 rounded-lg">
                            <i class="fas fa-star"></i>
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                        <div id="reputation-progress-bar" class="bg-yellow-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <span id="reputation-change" class="text-success mr-2">
                            <i class="fas fa-arrow-up"></i> 0
                        </span>
                        <span class="text-gray-500 dark:text-gray-400 text-sm">based on ratings & teacher satisfaction</span>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 mb-6">
                <h3 class="font-semibold mb-3">Financial Summary</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-100 dark:bg-dark-700 rounded-lg">
                        <div class="flex justify-between mb-1">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Weekly Revenue</h4>
                            <span class="text-success">$<span id="weekly-revenue">0.00</span></span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                            <div id="revenue-bar" class="bg-success h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-dark-700 rounded-lg">
                        <div class="flex justify-between mb-1">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Weekly Expenses</h4>
                            <span class="text-red-500">$<span id="weekly-expenses">0.00</span></span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                            <div id="expenses-bar" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-dark-700 rounded-lg">
                        <div class="flex justify-between mb-1">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Weekly Profit</h4>
                            <span class="text-primary">$<span id="weekly-profit">0.00</span></span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                            <div id="profit-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium">Earnings Overview</h3>
                        <select id="earnings-period" class="bg-gray-100 dark:bg-dark-700 text-sm rounded-lg px-3 py-1.5 border-none focus:ring-2 focus:ring-primary">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="chart-container h-64">
                        <canvas id="earnings-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 h-full">
                    <h3 class="font-medium mb-4">Active Teachers</h3>
                    <div id="active-teachers-list" class="space-y-4 max-h-64 overflow-y-auto scrollbar-hide">
                        <!-- Active teachers will be inserted here -->
                        <div class="text-gray-500 dark:text-gray-400 text-center py-8">
                            No active teachers
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="students-content" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg mb-2 md:mb-0">Available Students</h3>
                    <div class="flex space-x-2">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="students-search" 
                                placeholder="Search students..." 
                                class="pl-9 pr-4 py-2 bg-gray-100 dark:bg-dark-700 rounded-lg text-base w-full" 
                            />
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="students-filter" class="bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary">
                            <option value="all">All Students</option>
                            <option value="priority">Priority</option>
                            <option value="weekend">Weekend</option>
                            <option value="special">Special Needs</option>
                            <option value="returning">Returning</option>
                        </select>
                        <select id="students-sort" class="bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary">
                            <option value="deadline">Sort by Deadline</option>
                            <option value="payment">Sort by Tuition</option>
                            <option value="duration">Sort by Duration</option>
                            <option value="visits">Sort by Visits</option>
                        </select>
                    </div>
                </div>
                <div id="students-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Students will be inserted here -->
                    <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-user-graduate text-5xl mb-3 opacity-30"></i>
                        <p>No students available at the moment</p>
                        <p class="text-sm mt-1">Check back later or adjust your filters</p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-lg mb-4">Student Reviews</h3>
                <div id="student-reviews-list" class="space-y-4">
                    <!-- Student reviews will be inserted here -->
                    <div class="text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-star text-5xl mb-3 opacity-30"></i>
                        <p>No student reviews yet</p>
                        <p class="text-sm mt-1">Complete sessions to receive reviews</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="teachers-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Total Teachers</h3>
                        <span class="bg-primary bg-opacity-10 text-primary p-2 rounded-lg"><i class="fas fa-chalkboard-teacher"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2"><span id="total-teachers">0</span>/<span id="teacher-capacity">5</span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        <span id="teachers-change" class="text-success">
                            <i class="fas fa-arrow-up"></i> 0
                        </span>
                        since last week
                    </p>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Available Teachers</h3>
                        <span class="bg-green-500 bg-opacity-10 text-green-500 p-2 rounded-lg"><i class="fas fa-check-circle"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2"><span id="available-teachers">0</span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Ready for assignment</p>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Average Skill Level</h3>
                        <span class="bg-yellow-500 bg-opacity-10 text-yellow-500 p-2 rounded-lg"><i class="fas fa-star"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2"><span id="avg-skill">0</span>/10</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Across all specializations</p>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Average Salary</h3>
                        <span class="bg-blue-500 bg-opacity-10 text-blue-500 p-2 rounded-lg"><i class="fas fa-dollar-sign"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2">$<span id="avg-salary">0</span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Per teacher</p>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg mb-2 md:mb-0">Current Teachers</h3>
                    <div class="flex space-x-2">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="teachers-search" 
                                placeholder="Search teachers..." 
                                class="pl-9 pr-4 py-2 bg-gray-100 dark:bg-dark-700 rounded-lg text-base w-full" 
                            />
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="teachers-filter" class="bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary">
                            <option value="all">All Teachers</option>
                            <option value="available">Available</option>
                            <option value="off-duty">Off Duty</option>
                            <option value="high-skill">High Skill</option>
                            <option value="low-loyalty">Low Loyalty</option>
                        </select>
                        <select id="teachers-sort" class="bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary">
                            <option value="loyalty">Sort by Loyalty</option>
                            <option value="salary">Sort by Salary</option>
                            <option value="skill">Sort by Skill</option>
                            <option value="sessions">Sort by Sessions</option>
                        </select>
                    </div>
                </div>
                <div id="teachers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Teachers will be inserted here -->
                    <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-chalkboard-teacher text-5xl mb-3 opacity-30"></i>
                        <p>No teachers hired yet</p>
                        <p class="text-sm mt-1">Check the applicants section below</p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Teacher Applicants</h3>
                    <button id="refresh-applicants" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg shadow-sm text-sm flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Applicants
                    </button>
                </div>
                <div id="applicants-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Applicants will be inserted here -->
                    <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-user-plus text-5xl mb-3 opacity-30"></i>
                        <p>No teacher applications at the moment</p>
                        <p class="text-sm mt-1">Check back later or refresh the list</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="active-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">On-Time Sessions</h3>
                        <span class="bg-green-500 bg-opacity-10 text-green-500 p-2 rounded-lg"><i class="fas fa-clock"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2"><span id="on-time">0</span>%</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Last 7 days</p>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Total Hours</h3>
                        <span class="bg-blue-500 bg-opacity-10 text-blue-500 p-2 rounded-lg"><i class="fas fa-hourglass-half"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2"><span id="total-hours">0</span> hrs</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Taught this week</p>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-medium">Active Sessions Value</h3>
                        <span class="bg-primary bg-opacity-10 text-primary p-2 rounded-lg"><i class="fas fa-dollar-sign"></i></span>
                    </div>
                    <p class="text-2xl font-bold mt-2">$<span id="active-value">0</span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Currently in progress</p>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-lg mb-4">Active Sessions</h3>
                <div id="active-sessions-list" class="space-y-4">
                    <!-- Active sessions will be inserted here -->
                    <div class="text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-users-class text-5xl mb-3 opacity-30"></i>
                        <p>No active sessions</p>
                        <p class="text-sm mt-1">Assign teachers to students to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="company-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-lg mb-4">Company Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Company Name</h4>
                            <p class="font-medium text-lg" id="company-name">EduMaster Tutoring</p>
                            <button id="change-name-btn" class="text-primary text-sm hover:underline mt-1">
                                Change Name
                            </button>
                        </div>
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Founded</h4>
                            <p class="font-medium text-lg" id="company-founded">Today</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Reputation Score</h4>
                            <div class="flex items-center mt-1">
                                <div class="text-yellow-500 flex items-center" id="reputation-stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                    <i class="far fa-star"></i>
                                </div>
                                <span class="ml-2 font-medium" id="company-reputation">3.5</span>
                            </div>
                            <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">Based on session completion rate, teacher satisfaction, and student reviews</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Daily Session Quota</h4>
                            <p class="font-medium text-lg"><span id="company-quota">10</span> sessions per day</p>
                            <button id="upgrade-quota-btn" class="text-primary text-sm hover:underline mt-1">
                                Upgrade Quota ($5,000)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 h-full">
                    <h3 class="font-semibold text-lg mb-4">Financial Summary</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Total Revenue</h4>
                                <span class="text-success">$<span id="total-revenue">0.00</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                                <div id="revenue-bar-total" class="bg-success h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Total Expenses</h4>
                                <span class="text-red-500">$<span id="total-expenses">0.00</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                                <div id="expenses-bar-total" class="bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Net Profit</h4>
                                <span class="text-primary">$<span id="net-profit">0.00</span></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5">
                                <div id="profit-bar-total" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h4 class="font-medium mb-2">Seek Investment</h4>
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <p class="text-sm mb-3">Attract investors to increase your available capital</p>
                            <button id="seek-investment-btn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg shadow-sm">
                                Seek $50,000 Investment
                            </button>
                            <p class="text-gray-500 dark:text-gray-400 text-xs mt-2">Requires company reputation of 4.0 or higher</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 mb-6">
                <h3 class="font-semibold text-lg mb-4">Weekly Expenses Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    <div class="bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                        <div class="flex justify-between">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Office Rent</h4>
                            <span class="text-red-500">$<span id="rent-expense">300.00</span>/week</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Central location for tutoring</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                        <div class="flex justify-between">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Utilities</h4>
                            <span class="text-red-500">$<span id="utilities-expense">75.00</span>/week</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Electricity, internet, water</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                        <div class="flex justify-between">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Insurance</h4>
                            <span class="text-red-500">$<span id="insurance-expense">62.50</span>/week</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Liability and property coverage</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                        <div class="flex justify-between">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Advertising</h4>
                            <span class="text-red-500">$<span id="advertising-expense">125.00</span>/week</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Local ads and promotions</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-3 rounded-lg md:col-span-2 lg:col-span-4">
                        <div class="flex justify-between">
                            <h4 class="text-gray-500 dark:text-gray-400 text-sm">Administrative Staff</h4>
                            <span class="text-red-500">$<span id="admin-expense">500.00</span>/week</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reception, scheduling, and administration</p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-lg mb-4">Company History</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-dark-700">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Event</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Impact</th>
                            </tr>
                        </thead>
                        <tbody id="company-history" class="divide-y divide-gray-200 dark:divide-dark-600">
                            <!-- Company history events will be inserted here -->
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" id="company-start-date">—</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">Company Founded</td>
                                <td class="px-6 py-4 text-sm">EduMaster Tutoring was established</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-success">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100">
                                        Initial Capital $30,000
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="marketing-content" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5 mb-6">
                <h3 class="font-semibold text-lg mb-4">Marketing Campaigns</h3>
                <div id="marketing-locked" class="text-center py-8">
                    <i class="fas fa-lock text-5xl mb-3 text-gray-400"></i>
                    <p class="mb-4">Marketing campaigns are currently locked</p>
                    <button id="unlock-marketing-btn" class="bg-primary hover:bg-secondary text-white px-6 py-2 rounded-lg">
                        Unlock Marketing ($5,000)
                    </button>
                </div>
                
                <div id="marketing-campaigns" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                    <div class="bg-gray-100 dark:bg-dark-700 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium">Social Media Ads</h4>
                            <span class="text-blue-500"><i class="fab fa-facebook"></i> <i class="fab fa-instagram"></i> <i class="fab fa-tiktok"></i></span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Run targeted ads on social media platforms to attract local students.</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span>Cost:</span>
                                <span class="font-medium">$500</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Duration:</span>
                                <span class="font-medium">2 days</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Student Increase:</span>
                                <span class="font-medium">+1 max</span>
                            </div>
                        </div>
                        <button class="start-campaign-btn w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg" data-campaign="social">
                            Start Campaign
                        </button>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-dark-700 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium">School Flyers</h4>
                            <span class="text-green-500"><i class="fas fa-file-alt"></i></span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Distribute flyers at local schools to reach students and parents directly.</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span>Cost:</span>
                                <span class="font-medium">$1,000</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Duration:</span>
                                <span class="font-medium">2 days</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Student Increase:</span>
                                <span class="font-medium">+3 max</span>
                            </div>
                        </div>
                        <button class="start-campaign-btn w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg" data-campaign="flyers">
                            Start Campaign
                        </button>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-dark-700 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium">Tutoring Fair</h4>
                            <span class="text-yellow-500"><i class="fas fa-booth-curtain"></i></span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Host a booth at a local education fair to showcase your tutoring services.</p>
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span>Cost:</span>
                                <span class="font-medium">$1,500</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Duration:</span>
                                <span class="font-medium">2 days</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Student Increase:</span>
                                <span class="font-medium">+5 max</span>
                            </div>
                        </div>
                        <button class="start-campaign-btn w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg" data-campaign="fair">
                            Start Campaign
                        </button>
                    </div>
                </div>
                
                <div id="active-campaign" class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mt-4 hidden">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-medium" id="campaign-name">Campaign Name</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="campaign-description">Campaign description</p>
                        </div>
                        <div class="bg-blue-500 text-white px-2 py-1 rounded text-xs">
                            ACTIVE
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progress:</span>
                            <span id="campaign-progress">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                            <div id="campaign-progress-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Started:</span>
                            <span class="ml-1" id="campaign-start">--</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Ends:</span>
                            <span class="ml-1" id="campaign-end">--</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Investment:</span>
                            <span class="ml-1" id="campaign-cost">$0</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Students Gained:</span>
                            <span class="ml-1" id="campaign-students">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-lg mb-4">Marketing Analytics</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                        <h4 class="text-gray-500 dark:text-gray-400 text-sm">Student Acquisition</h4>
                        <p class="text-2xl font-bold mt-1"><span id="student-acquisition">0</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Students this week</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                        <h4 class="text-gray-500 dark:text-gray-400 text-sm">Retention Rate</h4>
                        <p class="text-2xl font-bold mt-1"><span id="retention-rate">0</span>%</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Returning students</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                        <h4 class="text-gray-500 dark:text-gray-400 text-sm">Marketing ROI</h4>
                        <p class="text-2xl font-bold mt-1"><span id="marketing-roi">0</span>%</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Return on investment</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                        <h4 class="text-gray-500 dark:text-gray-400 text-sm">Total Campaign Spend</h4>
                        <p class="text-2xl font-bold mt-1">$<span id="campaign-spend">0.00</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">All-time spending</p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-medium mb-3">Campaign History</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-dark-700">
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Campaign</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Cost</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Students Gained</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Revenue</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">ROI</th>
                                </tr>
                            </thead>
                            <tbody id="campaign-history" class="divide-y divide-gray-200 dark:divide-dark-600">
                                <!-- Campaign history will be inserted here -->
                                <tr>
                                    <td class="px-4 py-3 text-sm text-center" colspan="6">No campaign history yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="upgrades-content" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-lg mb-4">Teacher Lounge</h3>
                    <div class="flex items-center mb-3">
                        <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-lg mr-3">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div>
                            <p class="font-medium">Current Level: <span id="lounge-level">0</span>/5</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Loyalty Decay Reduction: <span id="lounge-effect">0</span>%</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        A comfortable teacher lounge helps retain teachers by reducing loyalty decay. Each level adds a 5% reduction.
                    </p>
                    <div id="lounge-upgrade-container" class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">Upgrade to Level <span id="next-lounge-level">1</span></span>
                            <span class="text-primary">$<span id="lounge-cost">5,000</span></span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Next level effect: <span id="next-lounge-effect">5</span>% loyalty decay reduction</p>
                        <button id="upgrade-lounge-btn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg">
                            Upgrade Teacher Lounge
                        </button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-lg mb-4">Office Expansion</h3>
                    <div class="flex items-center mb-3">
                        <div class="bg-blue-500 bg-opacity-10 text-blue-500 p-2 rounded-lg mr-3">
                            <i class="fas fa-building"></i>
                        </div>
                        <div>
                            <p class="font-medium">Teacher Capacity: <span id="total-capacity">5</span></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Current Expansions: <span id="office-upgrades">0</span></p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Expand your office to hire more teachers. Each upgrade adds 2 teacher slots.
                    </p>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">Office Expansion</span>
                            <span class="text-primary">$<span id="office-upgrade-cost">10,000</span></span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Effect: +2 teacher slots</p>
                        <button id="upgrade-office-btn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg">
                            Expand Office
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-lg mb-4">Teacher Workshop</h3>
                    <div class="flex items-center mb-3">
                        <div class="bg-green-500 bg-opacity-10 text-green-500 p-2 rounded-lg mr-3">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div>
                            <p class="font-medium">Professional Development</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" id="workshop-status">Available</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Host a workshop to boost all teachers' loyalty by 5% and give them a chance to improve their skills.
                        Available once per day at 9 PM.
                    </p>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">Host Workshop</span>
                            <span class="text-primary">$1,000</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Effect: +5% loyalty & chance for skill improvement</p>
                        <button id="host-workshop-btn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg">
                            Host Workshop
                        </button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                    <h3 class="font-semibold text-lg mb-4">Session Quota</h3>
                    <div class="flex items-center mb-3">
                        <div class="bg-yellow-500 bg-opacity-10 text-yellow-500 p-2 rounded-lg mr-3">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div>
                            <p class="font-medium">Current Quota: <span id="current-quota">10</span></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Sessions per day</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Increase the maximum number of sessions you can handle per day to grow your business.
                    </p>
                    <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">Upgrade Session Quota</span>
                            <span class="text-primary">$<span id="quota-upgrade-cost">5,000</span></span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Effect: +5 daily sessions</p>
                        <button id="quota-upgrade-btn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg">
                            Upgrade Quota
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-white dark:bg-dark-800 rounded-xl shadow-md p-5">
                <h3 class="font-semibold text-lg mb-4">Support the Developer</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-100 dark:bg-dark-700 p-5 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium">Buy Me a Coffee</h4>
                            <div class="w-8 h-8 rounded overflow-hidden">
                                <img src="https://cdn.ko-fi.com/cdn/kofi3.png?v=3" alt="Ko-fi" class="w-full h-full object-cover" />
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            If you're enjoying EduMaster Tutoring and want to support its development, consider buying me a coffee!
                        </p>
                        <a href="https://ko-fi.com/cygryu" target="_blank" class="block text-center bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                            Support on Ko-Fi
                        </a>
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-dark-700 p-5 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium">PayPal Donation</h4>
                            <div class="w-8 h-8 rounded overflow-hidden">
                                <img src="https://cdn.jsdelivr.net/gh/twolfson/paypal-github-button@1.0.0/dist/button.svg" alt="PayPal" class="w-full h-full object-cover" />
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Prefer to use PayPal? Your support helps me create more educational games and simulations.
                        </p>
                        <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="block text-center bg-blue-700 hover:bg-blue-800 text-white py-2 rounded-lg">
                            Donate via PayPal
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher assignment modal -->
        <div id="assignment-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Assign Teacher to Student</h3>
                    <button id="close-assignment-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="assignment-student-details" class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                    <!-- Student details will be inserted here -->
                </div>
                <h4 class="font-medium mb-3">Select a Teacher</h4>
                <div id="assignment-teachers-list" class="space-y-3 max-h-60 overflow-y-auto scrollbar-hide">
                    <!-- Available teachers will be inserted here -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="cancel-assignment" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-assignment" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg" disabled>
                        Confirm Assignment
                    </button>
                </div>
            </div>
        </div>

        <!-- Teacher detail modal -->
        <div id="teacher-detail-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Teacher Details</h3>
                    <button id="close-teacher-detail-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="teacher-detail-content" class="space-y-4">
                    <!-- Teacher details will be inserted here -->
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="terminate-teacher-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg hidden">
                        Terminate Employment
                    </button>
                    <button id="close-teacher-details" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Rename teacher modal -->
        <div id="rename-teacher-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Rename Teacher</h3>
                    <button id="close-rename-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="new-teacher-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Name</label>
                    <input 
                        type="text" 
                        id="new-teacher-name" 
                        class="w-full bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary" 
                        placeholder="Enter new name" 
                    />
                </div>
                <div class="flex justify-end">
                    <button id="cancel-rename" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-rename" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Adjust salary modal -->
        <div id="adjust-salary-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Adjust Teacher Salary</h3>
                    <button id="close-salary-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-3 bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                    <div id="current-teacher-info">
                        <!-- Teacher info will be inserted here -->
                    </div>
                </div>
                <div class="mb-4">
                    <label for="new-salary" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Weekly Base Salary</label>
                    <div class="flex items-center">
                        <span class="bg-gray-200 dark:bg-dark-600 px-3 py-2 rounded-l-lg">$</span>
                        <input 
                            type="number" 
                            id="new-salary" 
                            class="w-full bg-gray-100 dark:bg-dark-700 rounded-r-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary" 
                            placeholder="Enter new salary"
                            min="300"
                            max="2000"
                            step="50"
                        />
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Plus 30% commission on all sessions</p>
                </div>
                <div id="salary-impact" class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm hidden">
                    <!-- Salary impact will be shown here -->
                </div>
                <div class="flex justify-end">
                    <button id="cancel-salary-adjust" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-salary-adjust" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg" disabled>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Company rename modal -->
        <div id="rename-company-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Rename Company</h3>
                    <button id="close-company-rename-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="new-company-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Company Name</label>
                    <input 
                        type="text" 
                        id="new-company-name" 
                        class="w-full bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary" 
                        placeholder="Enter new company name" 
                    />
                </div>
                <div class="flex justify-end">
                    <button id="cancel-company-rename" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-company-rename" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Student nickname modal -->
        <div id="student-nickname-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Set Student Nickname</h3>
                    <button id="close-nickname-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-3 bg-gray-100 dark:bg-dark-700 p-3 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Student's Original Name:</p>
                    <p class="font-medium" id="student-original-name">Student Name</p>
                </div>
                <div class="mb-4">
                    <label for="student-nickname" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nickname</label>
                    <input 
                        type="text" 
                        id="student-nickname" 
                        class="w-full bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-base focus:ring-2 focus:ring-primary" 
                        placeholder="Enter nickname" 
                    />
                    <p class="text-xs text-gray-500 mt-1">This won't change the student's original name in the system.</p>
                </div>
                <div class="flex justify-end">
                    <button id="cancel-nickname" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-nickname" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg">
                        Save Nickname
                    </button>
                </div>
            </div>
        </div>

        <!-- Teacher termination modal -->
        <div id="termination-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Terminate Teacher Employment</h3>
                    <button id="close-termination-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4 bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                    <div class="flex items-center text-red-500 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <h4 class="font-medium">Warning</h4>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-2">
                        You are about to terminate <span id="termination-teacher-name" class="font-medium">Teacher Name</span>'s employment.
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        This action will:
                    </p>
                    <ul class="text-sm text-gray-600 dark:text-gray-400 list-disc list-inside mt-1 space-y-1">
                        <li>Require a termination fee of $<span id="termination-fee">0</span> (2 weeks' salary)</li>
                        <li>Decrease company reputation by 0.2 points</li>
                        <li>Remove the teacher from your staff</li>
                    </ul>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="termination-confirm-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">I understand the consequences and wish to proceed</span>
                    </label>
                </div>
                <div class="flex justify-end">
                    <button id="cancel-termination" class="bg-gray-200 hover:bg-gray-300 dark:bg-dark-700 dark:hover:bg-dark-600 px-4 py-2 rounded-lg mr-3">
                        Cancel
                    </button>
                    <button id="confirm-termination" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg opacity-50 cursor-not-allowed" disabled>
                        Terminate Employment
                    </button>
                </div>
            </div>
        </div>

        <!-- Session complete modal -->
<div id="session-complete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg p-6 w-full max-w-lg animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-lg">Session Completed</h3>
            <button id="close-session-complete-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="session-complete-details" class="space-y-4">
            <!-- Session details will be dynamically inserted here -->
        </div>
        <div class="mt-6 flex justify-end">
            <button id="session-complete-ok" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg">
                OK
            </button>
        </div>
    </div>
</div>

        <!-- Save/Export modal -->
        <div id="save-export-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-800 rounded-xl shadow-xl p-6 max-w-2xl w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Save/Load Game</h3>
                    <button id="close-save-export-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <h4 class="font-medium mb-2">Export Game Data</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Copy the string below to save your game progress. You can use it later to continue from where you left off.
                    </p>
                    <div class="relative">
                        <textarea 
                            id="export-data" 
                            class="w-full bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-xs font-mono focus:ring-2 focus:ring-primary h-32"
                            readonly
                        ></textarea>
                        <button id="copy-export-btn" class="absolute top-2 right-2 bg-primary text-white px-2 py-1 rounded text-xs">
                            Copy
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="font-medium mb-2">Import Game Data</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Paste a saved game string below to load a previous game state.
                    </p>
                    <div class="mb-3">
                        <textarea 
                            id="import-data" 
                            class="w-full bg-gray-100 dark:bg-dark-700 rounded-lg px-3 py-2 border-none text-xs font-mono focus:ring-2 focus:ring-primary h-32"
                            placeholder="Paste your saved game data here"
                        ></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button id="load-game-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg">
                            Load Game
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Reset Game</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        This will completely reset your game to the starting state. This action cannot be undone.
                    </p>
                    <div class="mb-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="reset-confirm-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">I understand this will erase all my progress</span>
                        </label>
                    </div>
                    <div class="flex justify-end">
                        <button id="reset-game-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg opacity-50 cursor-not-allowed" disabled>
                            Reset Game
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast notification system -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col space-y-2">
            <!-- Toast notifications will be inserted here -->
        </div>
        
        <!-- Save indicator -->
        <div id="save-indicator" class="save-indicator">
            <i class="fas fa-save mr-2"></i>Game saved
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 dark:text-gray-400 text-sm py-4 border-t border-gray-200 dark:border-gray-700">
            <p>EduMaster Tutoring Simulation | Developed by CygRyu</p>
        </footer>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Define subject categories for stricter matching
        const subjectCategories = {
            "Mathematics": ["Calculus", "Algebra", "Geometry", "Statistics", "Trigonometry"],
            "Science": ["Physics", "Chemistry", "Biology"],
            "English": ["English Literature", "Essay Writing", "Grammar", "Creative Writing"],
            "Languages": ["Spanish", "French", "German", "Mandarin", "Japanese"],
            "Computer Science": ["Programming", "Web Development", "Data Structures"],
            "Social Studies": ["History", "Geography", "Economics", "Political Science"],
            "Arts": ["Music", "Art & Design", "Drama", "Photography"]
        };

        // Flat map for quick lookup
        const subjectToCategory = {};
        Object.entries(subjectCategories).forEach(([category, subjects]) => {
            subjects.forEach(subject => {
                subjectToCategory[subject] = category;
            });
        });

        // Game state with enhancements
        const gameState = {
            // Company information
            company: {
                name: "EduMaster Tutoring",
                founded: new Date(),
                capital: 30000,
                reputation: 3.5,
                quota: 10,
                quotaUpgradeCost: 5000,
                teacherCapacity: 5,
                officeUpgradeCost: 10000,
                teacherLoungeLevel: 0,
                teacherLoungeCost: 5000,
                teacherLoungeEffect: 0,
                marketingUnlocked: false,
                sessionsCompleted: 0,
                totalRevenue: 0,
                teacherPayments: 0,
                operatingExpenses: 0,
                netProfit: 0,
                history: [],
                // Recurring expenses structure (weekly)
                expenses: {
                    rent: 300,
                    utilities: 75,
                    insurance: 62.5,
                    advertising: 125,
                    adminStaff: 500
                },
                // Weekly financial tracking
                weeklyStats: {
                    revenue: 0,
                    expenses: 0,
                    profit: 0,
                    lastWeekReset: new Date()
                },
            },
            // Marketing
            marketing: {
                unlocked: false,
                activeCampaign: null,
                maxStudentIncrease: 0,
                campaignHistory: [],
                totalSpend: 0,
                totalRevenue: 0,
                studentsGained: 0,
                lastWorkshopDay: -1,  // For tracking daily workshop limit
            },
            // Time tracking
            time: {
                day: 0,
                dayOfWeek: 0, // 0 = Sunday, 6 = Saturday
                week: 0,
                lastDayProcessed: null,
                hoursPassed: 0, // Track hours for fatigue recovery
                lastAutoSave: null, // For tracking auto-saving
            },
            // Teachers management
            teachers: [],
            applicants: [],
            // Students management
            availableStudents: [],
            activeSessions: [],
            completedSessions: [],
            returningStudents: [],
            studentReviews: [],
            // Stats tracking
            stats: {
                dailyEarnings: 0,
                weeklyEarnings: [0, 0, 0, 0, 0, 0, 0],
                monthlyEarnings: Array(30).fill(0),
                teacherSatisfaction: 85,
                onTimeRate: 92,
                totalHours: 0,
                studentAcquisition: 0,
                retentionRate: 0
            },
            // Notifications
            notifications: []
        };

        // Specialization areas for teacher generation
        const specializations = [
            { name: "Mathematics", pace: 4.1, efficiency: 4.2 },
            { name: "English", pace: 3.9, efficiency: 4.5 },
            { name: "Science", pace: 3.7, efficiency: 3.8 },
            { name: "Languages", pace: 3.5, efficiency: 3.9 },
            { name: "Computer Science", pace: 4.0, efficiency: 4.1 },
            { name: "Social Studies", pace: 4.2, efficiency: 4.3 },
            { name: "Arts", pace: 3.6, efficiency: 3.8 }
        ];

        // Schools for student generation
        const schools = [
            "SMA Negeri 1 Medan",
            "SMA Negeri 2 Medan",
            "SMA Negeri 3 Medan",
            "SMA Sutomo 1",
            "SMA Sutomo 2",
            "SMA Methodist 1",
            "SMA Methodist 2",
            "SMA Methodist 3",
            "SMA Negeri 4 Medan",
            "SMA Santo Thomas 1",
            "SMA Santo Thomas 2",
            "SMA Negeri 5 Medan",
            "SMA Buddhis Bodhicitta",
            "SMA Buddhis Wiyata Dharma",
            "SMA Budi Murni 1",
            "SMA Budi Murni 2",
            "SMA Cinta Budaya",
            "SMA Kalam Kudus",
            "SMA Prime One",
            "SMA Santa Maria",
            "SMA Singapore Indonesia",
            "SMA Singapore Piaget Acamedy",
            "Chandra Kusuma School",
            "Medan International School",
            "Methodist Charles Wesley School",
            "Sekolah Bangun Insan Mandiri",
            "Sekolah Pekerti Bangsa"	
        ];

        // First names representing Medan's diverse population
        const firstNames = [
            "Tulus", "Lamhot", "Bintang", "Tiurma", "Sondang", "Posma", "Parulian", "Hotma", "Sahala", "Romauli",
            "Dohar", "Bontor", "Sahat", "Liberty", "Poltak", "Donda", "Mangasi", "Kristovel", "Mutiara", "Rumondang",
            "Bambang", "Sutanto", "Joko", "Agus", "Widodo", "Sari", "Dewi", "Endang", "Yanti", "Sri",
            "Budi", "Wahyu", "Taufik", "Retno", "Eko", "Wulandari", "Purnomo", "Ayu", "Sulistyo", "Handayani",
            "Hendra", "Lim", "Fendi", "Lili", "Merry", "Fenny", "Wilson", "Kelvin", "Cynthia", "Jessica", "Japrinus",
            "Richard", "Steven", "Cindy", "David", "Yohan", "Melinda", "William", "Sherly", "Andreas", "Olivia",
            "Rizal", "Zulkifli", "Tengku", "Fatimah", "Malik", "Siti", "Azizah", "Farid", "Hamzah", "Aminah",
            "Faizal", "Ismail", "Nurul", "Rahmad", "Putri", "Hafiz", "Amira", "Arif", "Zahra", "Khairul",
            "Zikri", "Fadli", "Adri", "Fitri", "Rahmi", "Yusri", "Ranti", "Indah", "Ridwan", "Syafrizal",
            "Irfan", "Yulizar", "Novri", "Desi", "Rafli", "Putra", "Rini", "Agung", "Liza", "Budi",
            "Teuku", "Mukhlis", "Cut", "Rahmati", "Jamaluddin", "Safira", "Zulfikar", "Meutia", "Razak", "Marlina",
            "Saifuddin", "Nurdin", "Pocut", "Rizky", "Maulana", "Mariam", "Faisal", "Sarina", "Fuad", "Nabila",
            "Rajan", "Suresh", "Anand", "Lakshmi", "Priya", "Devi", "Kumar", "Aditya", "Sunita", "Vijay",
            "Ganesh", "Ramesh", "Kavita", "Deepak", "Gayatri", "Rahul", "Amita", "Vikram", "Meena", "Sanjay",
            "Brandon", "Darren", "Caroline", "Kevin", "Michelle", "Albert", "Vivian", "Jonathan", "Ellen", "Raymond", "Denny",
            "Michael", "Jennifer", "Christian", "Stephanie", "Kenny", "Angelina", "Vincent", "Claudia", "Daniel", "Giselle",
            "Edward", "Natasha", "Ryan", "Sharon", "Jeremy", "Vanessa", "Jason", "Tiffany", "Justin", "Melissa"
        ];

        // Last names representing Medan's diverse population
        const lastNames = [
            "Siahaan", "Sihombing", "Simanjuntak", "Situmorang", "Panjaitan", "Hutabarat", "Sitorus", "Sinaga", "Nainggolan", "Tampubolon",
            "Samosir", "Simbolon", "Silalahi", "Simatupang", "Napitupulu", "Pardede", "Manurung", "Hutagalung", "Purba", "Damanik",
            "Tan", "Lie", "Go", "Oei", "Tjoa", "Lim", "Tjioe", "Ng", "Wong", "Wijaya", "Kosiady", "Gunawan",
            "Tanuwijaya", "Gunawan", "Salim", "Santoso", "Winata", "Halim", "Hartono", "Tiono", "Kusnadi", "Tedja",
            "Harahap", "Batubara", "Lubis", "Siregar", "Hasibuan", "Nasution", "Rangkuti", "Daulay", "Matondang", "Dalimunthe",
            "Ritonga", "Pohan", "Rambe", "Pulungan", "Tanjung", "Simbolon", "Siagian", "Pane", "Saragih", "Hrp",
            "Wibowo", "Santoso", "Yudhoyono", "Sukarno", "Soekarno", "Sugianto", "Hartono", "Gunawan", "Susanto", "Hidayat",
            "Nugroho", "Kusuma", "Pratama", "Sulistyo", "Wijaya", "Sudrajat", "Purnama", "Handoko", "Setiawan", "Mulyono",
            "Rajah", "Tambunan", "Chetty", "Pillai", "Singh", "Mudaliar", "Govindarajan", "Iyer", "Naidu", "Ayyar",
            "Kapoor", "Sharma", "Shastri", "Balasubramaniam", "Venkatesh", "Chandran", "Krishnan", "Murthy", "Swamy", "Das",
            "Chaniago", "Tanjung", "Nasution", "Lubis", "Harahap", "Pakpahan", "Marpaung", "Sibuea", "Purba", "Rambe",
            "Jamil", "Makmur", "Ibrahim", "Koto", "Jambak", "Majid", "Syafei", "Kamal", "Rasyid", "Anwar",
            "Gea", "Hulu", "Larosa", "Telaumbanua", "Zebua", "Zalukhu", "Lase", "Mendrofa", "Harefa", "Zega",
            "Ziliwu", "Yafahari", "Bawamenewi", "Laoli", "Ndruru", "Fau", "Waruwu", "Halawa", "Daeli", "Duha",
            "Daud", "Iskandar", "Ibrahim", "Mahmud", "Hanafiah", "Syahputra", "Maulana", "Syafii", "Ramadhan", "Putra",
            "Aziz", "Ali", "Hakim", "Siddiq", "Basri", "Yusuf", "Arifin", "Hamid", "Zain", "Bahri",
            "Wijaya", "Fernando", "Laurens", "Wilson", "Anderson", "Ricardo", "Winston", "Leonardi", "Lawrence", "Alexander",
            "Christopher", "Handoko", "Giovanni", "Leonardo", "Jefferson", "Wijanto", "Hartanto", "Christianto", "Stephen", "Wilianto"
        ];

        // Define marketing campaign types
        const marketingCampaigns = {
            social: {
                name: "Social Media Ads",
                description: "Running targeted ads on popular social platforms",
                cost: 500,
                duration: 2, // days
                studentIncrease: 1,
                icon: '<i class="fab fa-facebook"></i> <i class="fab fa-instagram"></i> <i class="fab fa-tiktok"></i>'
            },
            flyers: {
                name: "School Flyers",
                description: "Distributing promotional materials at local schools",
                cost: 1000,
                duration: 2, // days
                studentIncrease: 3,
                icon: '<i class="fas fa-file-alt"></i>'
            },
            fair: {
                name: "Tutoring Fair",
                description: "Hosting a booth at an educational fair",
                cost: 1500,
                duration: 2, // days
                studentIncrease: 5,
                icon: '<i class="fas fa-booth-curtain"></i>'
            }
        };

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }

        function formatDurationAndTime(duration, pace) {
            const hours = duration / pace;
            const formattedHours = Math.floor(hours);
            const formattedMinutes = Math.round((hours - formattedHours) * 60);
            
            if (formattedHours === 0) {
                return `${formattedMinutes}m`;
            } else if (formattedMinutes === 0) {
                return `${formattedHours}h`;
            } else {
                return `${formattedHours}h ${formattedMinutes}m`;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula to calculate distance between two coordinates
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return Math.round(distance);
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomFloat(min, max, decimals = 2) {
            const value = Math.random() * (max - min) + min;
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        }

        function getRandomWorkingHours() {
            // Restrict start hour between 7 AM and 3 PM (to allow for minimum 6-hour shifts ending by 9 PM)
            const startHour = getRandomInt(7, 15);
            
            // Determine shift length (between 4 and 8 hours for realistic teaching schedules)
            const shiftLength = getRandomInt(4, 8);
            
            // Calculate end hour, capping at 9 PM (21:00)
            let endHour = Math.min(startHour + shiftLength, 21);
            
            const formatHour = (hour) => {
                return hour.toString().padStart(2, '0') + ':00';
            };
            
            return {
                start: formatHour(startHour),
                end: formatHour(endHour),
                duration: endHour - startHour
            };
        }

        function isTeacherAvailable(teacher) {
            if (teacher.active) return false;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour + (currentMinute / 60);
            
            const startHour = parseInt(teacher.workingHours.start.split(':')[0]);
            const endHour = parseInt(teacher.workingHours.end.split(':')[0]);
            
            if (endHour > startHour) {
                return currentTime >= startHour && currentTime < endHour;
            } else {
                return currentTime >= startHour || currentTime < endHour;
            }
        }

        function updateTeacherAvailability() {
            gameState.teachers.forEach(teacher => {
                teacher.available = isTeacherAvailable(teacher) && !teacher.active;
            });
            
            updateTeachersCount();
        }

        function isWeekend() {
            const day = new Date().getDay();
            return day === 0 || day === 6;
        }

        function generateRandomName() {
            return `${getRandomElement(firstNames)} ${getRandomElement(lastNames)}`;
        }

        function generateRandomSkill(reputationBonus = 0) {
            // Base skill range 1-10, with reputation bonus added
            const base = getRandomInt(1, 10);
            return Math.min(10, base + reputationBonus);
        }

        // Modified to support reputation bonus and loyalty system
        function generateRandomTeacher(reputationBonus = 0) {
            const specialization = getRandomElement(specializations);
            const workingHours = getRandomWorkingHours();
            
            return {
                id: Date.now() + Math.floor(Math.random() * 1000),
                name: generateRandomName(),
                skills: {
                    onlineTeaching: generateRandomSkill(reputationBonus),
                    groupTeaching: generateRandomSkill(reputationBonus),
                    specialNeeds: generateRandomSkill(reputationBonus),
                    teachingEfficiency: generateRandomSkill(reputationBonus)
                },
                specialization: {
                    area: specialization.name,
                    pace: specialization.pace,
                    efficiency: specialization.efficiency
                },
                workingHours: {
                    start: workingHours.start,
                    end: workingHours.end,
                    duration: workingHours.duration
                },
                fatigue: getRandomInt(1, 10),
                fatigueRecoveryRate: getRandomFloat(0.8, 1.2),
                loyalty: getRandomInt(75, 100),
                salary: getRandomInt(500, 900),
                active: false,
                available: false,
                hireDate: new Date(),
                lastFatigueUpdate: new Date(),
                sessionsCompleted: 0, // Track completed sessions for loyalty rewards
                lastSessionDate: new Date(), // Track for loyalty decay
                risk: false, // For indicating risk of quitting
                disengaged: false // For performance penalties
            };
        }

        // Updated student generation with new pricing model and student retention
        function generateRandomStudent(isReturning = false) {
            const location = getRandomElement(locations);
            let studentLocation;
            
            do {
                studentLocation = getRandomElement(locations);
            } while (studentLocation.name === location.name);
            
            const subject = getRandomElement(subjects);
            const hours = getRandomInt(Math.ceil(subject.duration * 0.7), Math.ceil(subject.duration * 1.3));
            
            // New pricing model: base rate × hours × modifiers
            const baseTuition = subject.baseRate * hours;
            let tuition = baseTuition;
            
            const isPriority = Math.random() > 0.7;
            const isWeekendSession = Math.random() > 0.6;
            const isSpecialNeeds = subject.difficulty > 6;
            
            if (isPriority) tuition *= 1.25;
            if (isWeekendSession) tuition *= 1.35;
            if (isSpecialNeeds) tuition *= 1.2;
            
            // Add reputation premium for high reputation
            if (gameState.company.reputation >= 4.0) {
                const premiumPercent = (gameState.company.reputation - 4.0) * 20; // 0-20% premium
                tuition *= (1 + premiumPercent / 100);
            }
            
            // Calculate deadline based on session parameters
            const now = new Date();
            const baseHours = hours * 1.5; // Some buffer time
            const deadlineHours = baseHours * (isPriority ? 1.2 : 1.8);
            const deadline = new Date(now.getTime() + (deadlineHours * 60 * 60 * 1000));
            
            // Generate base student
            const student = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                name: generateRandomName(),
                nickname: "", // For student nickname feature
                school: getRandomElement(schools),
                location: location,
                studentLocation: studentLocation,
                hours,
                subject: {
                    name: subject.name,
                    difficulty: subject.difficulty,
                    baseRate: subject.baseRate,
                    category: subjectToCategory[subject.name] || "General"
                },
                tuition: Math.round(tuition),
                deadline,
                isPriority,
                isWeekendSession,
                isSpecialNeeds,
                createdAt: now,
                grade: getRandomInt(10, 12),
                notes: "",
                visits: isReturning ? getRandomInt(1, 5) : 0, // Number of previous visits
                isReturning: isReturning, // Track if this is a returning student
                lastSessionRating: isReturning ? getRandomInt(3, 5) : 0 // Rating from previous session
            };
            
            return student;
        }

function generateStudents(count, maxReturning = 1) {
    const now = new Date();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6; // 0 = Sunday, 6 = Saturday
    const returningCount = Math.min(maxReturning, gameState.returningStudents.length);
    const newCount = count - returningCount;

    // Your provided data
    const locations = [
        { name: "Medan Kota", lat: 3.5896, lon: 98.6738 },
        { name: "Medan Maimun", lat: 3.5766, lon: 98.6729 },
        { name: "Medan Baru", lat: 3.5651, lon: 98.6500 },
        { name: "Selayang", lat: 3.5554, lon: 98.6274 },
        { name: "Johor", lat: 3.5303, lon: 98.6719 },
        { name: "Petisah", lat: 3.5933, lon: 98.6567 },
        { name: "Sunggal", lat: 3.5754, lon: 98.6277 },
        { name: "Polonia", lat: 3.5791, lon: 98.6643 },
        { name: "Amplas", lat: 3.5476, lon: 98.6925 },
        { name: "Helvetia", lat: 3.6048, lon: 98.6321 },
        { name: "Tuntungan", lat: 3.5278, lon: 98.6032 },
        { name: "Medan Timur", lat: 3.5969, lon: 98.6872 },
        { name: "Medan Barat", lat: 3.5937, lon: 98.6661 },
        { name: "Medan Area", lat: 3.5881, lon: 98.6865 },
        { name: "Deli", lat: 3.6376, lon: 98.6801 },
        { name: "Tembung", lat: 3.6068, lon: 98.7054 },
        { name: "Denai", lat: 3.5738, lon: 98.7060 },
        { name: "Medan Labuhan", lat: 3.7324, lon: 98.6920 },
        { name: "Belawan", lat: 3.7849, lon: 98.6833 },
        { name: "Marelan", lat: 3.6915, lon: 98.6532 }
    ];

    const subjects = [
        // Mathematics
        { name: "Calculus", baseRate: 55, difficulty: 9, duration: 3, category: "Mathematics" },
        { name: "Algebra", baseRate: 45, difficulty: 6, duration: 2, category: "Mathematics" },
        { name: "Geometry", baseRate: 45, difficulty: 5, duration: 2, category: "Mathematics" },
        { name: "Statistics", baseRate: 50, difficulty: 7, duration: 2.5, category: "Mathematics" },
        { name: "Trigonometry", baseRate: 45, difficulty: 6, duration: 2, category: "Mathematics" },
        // Science
        { name: "Physics", baseRate: 50, difficulty: 8, duration: 3, category: "Science" },
        { name: "Chemistry", baseRate: 50, difficulty: 7, duration: 2.5, category: "Science" },
        { name: "Biology", baseRate: 45, difficulty: 5, duration: 2, category: "Science" },
        // English
        { name: "English Literature", baseRate: 40, difficulty: 5, duration: 2, category: "English" },
        { name: "Essay Writing", baseRate: 45, difficulty: 6, duration: 1.5, category: "English" },
        { name: "Grammar", baseRate: 40, difficulty: 4, duration: 1.5, category: "English" },
        { name: "Creative Writing", baseRate: 45, difficulty: 6, duration: 2, category: "English" },
        // Languages
        { name: "Spanish", baseRate: 45, difficulty: 5, duration: 2, category: "Languages" },
        { name: "French", baseRate: 45, difficulty: 5, duration: 2, category: "Languages" },
        { name: "German", baseRate: 45, difficulty: 6, duration: 2, category: "Languages" },
        { name: "Mandarin", baseRate: 50, difficulty: 8, duration: 2.5, category: "Languages" },
        { name: "Japanese", baseRate: 50, difficulty: 8, duration: 2.5, category: "Languages" },
        // Computer Science
        { name: "Programming", baseRate: 60, difficulty: 8, duration: 2.5, category: "Computer Science" },
        { name: "Web Development", baseRate: 55, difficulty: 7, duration: 2.5, category: "Computer Science" },
        { name: "Data Structures", baseRate: 60, difficulty: 9, duration: 3, category: "Computer Science" },
        // Social Studies
        { name: "History", baseRate: 40, difficulty: 5, duration: 2, category: "Social Studies" },
        { name: "Geography", baseRate: 40, difficulty: 5, duration: 2, category: "Social Studies" },
        { name: "Economics", baseRate: 45, difficulty: 6, duration: 2, category: "Social Studies" },
        { name: "Political Science", baseRate: 45, difficulty: 6, duration: 2, category: "Social Studies" },
        // Arts
        { name: "Music", baseRate: 40, difficulty: 5, duration: 2, category: "Arts" },
        { name: "Art & Design", baseRate: 40, difficulty: 5, duration: 2, category: "Arts" },
        { name: "Drama", baseRate: 40, difficulty: 5, duration: 2, category: "Arts" },
        { name: "Photography", baseRate: 45, difficulty: 6, duration: 2, category: "Arts" }
    ];

    // Helper function to generate a random student
    function generateRandomStudent(isReturning = false) {
        const subject = subjects[Math.floor(Math.random() * subjects.length)];
        const location = locations[Math.floor(Math.random() * locations.length)];
        const isPriority = Math.random() < 0.2;
        const isWeekendSession = isWeekend ? (Math.random() < 0.3) : false; // Only on weekends
        const isSpecialNeeds = Math.random() < 0.15;

        // Tuition calculation
        let tuition = subject.baseRate * subject.duration * 2.5;
        if (isPriority) tuition *= 1.25;
        if (isWeekendSession) tuition *= 1.35;
        if (isSpecialNeeds) tuition *= 1.2;

        // Define working hours (8 AM to 9 PM)
        const startHour = 8;  // 8 AM
        const endHour = 21;   // 9 PM

        // Calculate deadline within 1-7 days, capped at 9 PM
        const deadline = new Date();
        const daysAhead = Math.floor(Math.random() * 7) + 1; // 1-7 days from now
        deadline.setDate(deadline.getDate() + daysAhead);

        // Set deadline to a random hour between 8 AM and 9 PM
        const randomHour = Math.floor(Math.random() * (endHour - startHour + 1)) + startHour; // 8-21 inclusive
        deadline.setHours(randomHour, 0, 0, 0);

        // Ensure it doesn’t exceed 9 PM
        if (deadline.getHours() > endHour) {
            deadline.setHours(endHour, 0, 0, 0);
        }

        return {
            id: Date.now() + Math.floor(Math.random() * 1000), // Unique ID
            name: generateRandomName(), // Assuming this function exists
            nickname: "",
            school: `${location.name} High`,
            subject: {
                name: subject.name,
                category: subject.category,
                baseRate: subject.baseRate,
                difficulty: subject.difficulty,
                duration: subject.duration
            },
            location: {
                name: location.name,
                lat: location.lat,
                lon: location.lon
            },
            hours: subject.duration, // Use subject duration as base hours
            tuition: Math.round(tuition),
            deadline,
            isPriority,
            isWeekendSession,
            isSpecialNeeds,
            visits: isReturning ? 1 : 0, // Default for new students
            lastSessionRating: null // Default for new students
        };
    }

    // Add returning students first
    for (let i = 0; i < returningCount && gameState.returningStudents.length > 0; i++) {
        const returningStudentTemplate = gameState.returningStudents.shift();
        const student = generateRandomStudent(true);
        student.name = returningStudentTemplate.name;
        student.nickname = returningStudentTemplate.nickname || "";
        student.school = returningStudentTemplate.school;
        student.visits = (returningStudentTemplate.visits || 0) + 1; // Increment visits
        student.lastSessionRating = returningStudentTemplate.rating || null;
        gameState.availableStudents.push(student);
        gameState.stats.studentAcquisition++;
    }

    // Add new students
    for (let i = 0; i < newCount; i++) {
        const student = generateRandomStudent();
        gameState.availableStudents.push(student);
        gameState.stats.studentAcquisition++;
    }

    // Calculate retention rate
    const totalCompletedSessions = gameState.completedSessions.length;
    if (totalCompletedSessions > 0) {
        const returningCount = gameState.completedSessions.filter(s => s.returnedForMore).length;
        gameState.stats.retentionRate = Math.round((returningCount / totalCompletedSessions) * 100);
    } else {
        gameState.stats.retentionRate = 0;
    }

    // Sort students by deadline
    gameState.availableStudents.sort((a, b) => a.deadline - b.deadline);

    // Update UI
    updateStudentsCount();
    renderStudentsList();
}

function adjustExistingStudentDeadlines() {
    const endHour = 21; // 9 PM
    gameState.availableStudents.forEach(student => {
        const deadline = new Date(student.deadline);
        if (deadline.getHours() > endHour) {
            deadline.setHours(endHour, 0, 0, 0);
            student.deadline = deadline;
        }
    });
    renderStudentsList();
}

        function generateApplicants(count) {
            // Calculate reputation bonus (0 to 1 point for reputation 4-5)
            const reputationBonus = gameState.company.reputation >= 4.0 ? 
                Math.floor((gameState.company.reputation - 4.0) * 2) : 0;
            
            const newApplicants = [];
            for (let i = 0; i < count; i++) {
                newApplicants.push(generateRandomTeacher(reputationBonus));
            }
            gameState.applicants = newApplicants;
            renderApplicantsList();
        }

        // Modified for performance impact from teacher loyalty
function moveStudentToActive(studentId, teacherId) {
    // Find student and teacher
    const studentIndex = gameState.availableStudents.findIndex(student => student.id === studentId);
    const teacher = gameState.teachers.find(t => t.id === teacherId);

    // Early exit if student or teacher not found
    if (studentIndex === -1 || !teacher) {
        addNotification("Error: Student or teacher not found.", "error");
        return null;
    }

    const student = gameState.availableStudents[studentIndex];
    const now = new Date();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6; // 0 = Sunday, 6 = Saturday

    // Prevent assigning weekend students on weekdays
    if (student.isWeekendSession && !isWeekend) {
        addNotification("Error: Weekend students can only be assigned on weekends.", "error");
        return null;
    }

    // Calculate session duration based on teacher's pace
    const durationHours = student.hours / teacher.specialization.pace;
    const startTime = new Date();
    const estimatedEnd = new Date(startTime.getTime() + (durationHours * 60 * 60 * 1000));

    // Session performance modifiers
    let performanceScore = 100;
    if (student.isWeekendSession) {
        performanceScore += (teacher.skills.onlineTeaching - 5) * 2; // Online teaching skill impact
    }
    if (student.isSpecialNeeds) {
        performanceScore += (teacher.skills.specialNeeds - 5) * 2; // Special needs skill impact
    }
    performanceScore += (teacher.skills.teachingEfficiency - 5) * 1.5; // Teaching efficiency impact

    // Apply loyalty impact on performance
    if (teacher.disengaged) {
        performanceScore -= 20; // Major penalty for disengaged teachers
    } else if (teacher.loyalty < 70) {
        performanceScore -= (70 - teacher.loyalty) / 2; // Up to -20 for low loyalty
    }

    // Subject matching logic
    const teacherArea = teacher.specialization.area;
    const studentSubject = student.subject.name;
    const studentCategory = student.subject.category;

    let subjectMatchScore = 0;
    if (teacherArea === studentCategory) {
        subjectMatchScore = 10; // Perfect match
    } else if (subjectCategories[teacherArea]?.includes(studentSubject)) {
        subjectMatchScore = 5; // Good match
    } else {
        subjectMatchScore = -20; // Mismatch penalty
    }
    performanceScore += subjectMatchScore * 2;

    // Cap performance score between 60 and 100
    performanceScore = Math.max(60, Math.min(performanceScore, 100));

    // Adjust end time based on performance (higher score = faster completion)
    const performanceFactor = performanceScore / 100;
    const adjustedEnd = new Date(startTime.getTime() + (durationHours * 60 * 60 * 1000 * (2 - performanceFactor)));

    // Create active session object
    const activeSession = {
        id: Date.now() + Math.floor(Math.random() * 1000),
        student,
        teacher: teacher.id,
        startTime,
        estimatedEnd,
        adjustedEnd,
        performanceScore,
        subjectMatchScore,
        status: 'in-progress'
    };

    // Update teacher state
    teacher.active = true;
    teacher.available = false;
    teacher.currentSession = activeSession.id;
    teacher.fatigue += Math.ceil(durationHours / 2);
    teacher.fatigue = Math.min(teacher.fatigue, 100);
    teacher.lastFatigueUpdate = new Date();
    teacher.lastSessionDate = new Date();

    // Move student from available to active sessions
    gameState.availableStudents.splice(studentIndex, 1);
    gameState.activeSessions.push(activeSession);

    // Generate a new student to replace the assigned one, respecting day context
    generateStudents(1);

    // Update UI
    updateTeachersCount();
    updateActiveSessionsCount();
    updateStudentsCount();
    renderStudentsList();
    renderActiveSessionsList();
    renderActiveTeachersList();
    renderTeachersList();

    // Add notification
    addNotification(`${teacher.name} assigned to tutor ${student.nickname || student.name} in ${student.subject.name}.`, "success");

    return activeSession;
}

        // Enhanced with student ratings and retention
        function completeSession(sessionId, force = false) {
            const sessionIndex = gameState.activeSessions.findIndex(session => session.id === sessionId);
            
            if (sessionIndex === -1) return null;
            
            const session = gameState.activeSessions[sessionIndex];
            const teacher = gameState.teachers.find(teacher => teacher.id === session.teacher);
            
            if (!teacher) return null;
            
            // Mark as completed
            session.status = 'completed';
            session.completedAt = new Date();
            
            // Check if on time or late
            const isOnTime = session.completedAt <= session.student.deadline;
            
            // Calculate payment - base rate plus commission
            const tuition = session.student.tuition;
            const baseHourlyRate = 30; // Base hourly rate for teachers
            const hours = session.student.hours;
            
            // Teacher gets base hourly rate plus 30% commission on the tuition
            const teacherPayment = (baseHourlyRate * hours) + (tuition * 0.3);
            // Company keeps the rest
            const companyPayment = tuition - teacherPayment;
            
            // Update company financials
            gameState.company.totalRevenue += tuition;
            gameState.company.teacherPayments += teacherPayment;
            gameState.company.netProfit += companyPayment;
            gameState.company.capital += companyPayment;
            gameState.company.sessionsCompleted++;
            
            // Update weekly tracking
            gameState.company.weeklyStats.revenue += companyPayment;
            gameState.company.weeklyStats.profit = gameState.company.weeklyStats.revenue - gameState.company.weeklyStats.expenses;
            
            // Update daily and historical earnings
            gameState.stats.dailyEarnings += companyPayment;
            
            const today = new Date().getDay();
            gameState.stats.weeklyEarnings[today] += companyPayment;
            
            const dayOfMonth = new Date().getDate() - 1;
            gameState.stats.monthlyEarnings[dayOfMonth] += companyPayment;
            
            // Update teacher stats
            teacher.active = false;
            teacher.currentSession = null;
            teacher.sessionsCompleted++;
            
            // Apply session loyalty reward (every 5 sessions)
            if (teacher.sessionsCompleted % 5 === 0) {
                const loyaltyBoost = 5;
                teacher.loyalty = Math.min(100, teacher.loyalty + loyaltyBoost);
                addNotification(`${teacher.name} received a ${loyaltyBoost}% loyalty boost for completing ${teacher.sessionsCompleted} sessions!`, "success");
            }
            
            // Adjust teacher loyalty based on session outcome and subject match
            const subjectMatchBonus = session.subjectMatchScore > 0 ? 1 : -1;
            
            if (isOnTime) {
                teacher.loyalty += 2 + subjectMatchBonus;
            } else {
                teacher.loyalty -= 3 - subjectMatchBonus;
            }
            teacher.loyalty = Math.max(0, Math.min(teacher.loyalty, 100));
            
            // Update teacher risk/disengaged status based on loyalty
            teacher.risk = teacher.loyalty < 30;
            teacher.disengaged = teacher.loyalty < 50;
            
            // Generate student rating
            let rating = 0;
            if (session.performanceScore >= 90) {
                rating = getRandomInt(4, 5); // Excellent: 4-5 stars
            } else if (session.performanceScore >= 75) {
                rating = getRandomInt(3, 4); // Good: 3-4 stars
            } else if (session.performanceScore >= 60) {
                rating = getRandomInt(2, 3); // Average: 2-3 stars
            } else {
                rating = getRandomInt(1, 2); // Poor: 1-2 stars
            }
            
            // Add student review
            const studentName = session.student.nickname || session.student.name;
            const review = {
                id: Date.now(),
                studentName,
                teacherName: teacher.name,
                subject: session.student.subject.name,
                rating,
                date: new Date(),
                comment: generateReviewComment(rating, session.student.subject.name)
            };
            
            gameState.studentReviews.unshift(review);
            if (gameState.studentReviews.length > 20) {
                gameState.studentReviews.pop(); // Keep only last 20 reviews
            }
            
            // Determine if student will return
            const returnChance = calculateReturnChance(rating, session.student.visits);
            const willReturn = Math.random() < returnChance;
            
            // Add student to returning list if they will return
            if (willReturn) {
                gameState.returningStudents.push({
                    name: session.student.name,
                    nickname: session.student.nickname,
                    school: session.student.school,
                    visits: (session.student.visits || 0) + 1,
                    rating
                });
            }
            
            // Update on-time rate
            const totalCompletedSessions = gameState.completedSessions.length + 1;
            const onTimeSessions = gameState.completedSessions.filter(session => session.isOnTime).length + (isOnTime ? 1 : 0);
            gameState.stats.onTimeRate = Math.round((onTimeSessions / totalCompletedSessions) * 100);
            
            // Add to completed sessions
            gameState.completedSessions.push({
                ...session,
                isOnTime,
                teacherPayment,
                companyPayment,
                rating,
                returnedForMore: willReturn
            });
            
            // Remove from active sessions
            gameState.activeSessions.splice(sessionIndex, 1);
            
            // Update stats
            gameState.stats.totalHours += session.student.hours;
            
            // Add notification based on rating
            let ratingText = "";
            if (rating >= 4) {
                ratingText = `They gave a ${rating}-star review!`;
            } else if (rating >= 3) {
                ratingText = `They gave a ${rating}-star review.`;
            } else {
                ratingText = `Warning: They gave only a ${rating}-star review.`;
            }
            
            if (isOnTime) {
                addNotification(`${teacher.name} completed tutoring ${studentName} in ${session.student.subject.name} on time! Earned $${formatCurrency(companyPayment)}. ${ratingText}`, rating >= 4 ? "success" : (rating <= 2 ? "warning" : "info"));
            } else {
                addNotification(`${teacher.name} completed tutoring ${studentName} in ${session.student.subject.name} late. Earned $${formatCurrency(companyPayment)}. ${ratingText}`, "warning");
            }
            
            // Update company reputation
            updateCompanyReputation();
            
            // Update UI
            updateCompanyInfo();
            updateActiveSessionsCount();
            updateDashboardStats();
            renderActiveSessionsList();
            renderTeachersList();
            renderStudentReviews();
            
            // If we were in an active marketing campaign, track the revenue
            if (gameState.marketing.activeCampaign) {
                gameState.marketing.totalRevenue += companyPayment;
            }
            
            return {
                session,
                isOnTime,
                teacherPayment,
                companyPayment,
                rating
            };
        }

        // Calculate chance of student returning based on rating and previous visits
        function calculateReturnChance(rating, visits) {
            // Base chance from rating (1-5 stars)
            let baseChance = rating / 10; // 0.1 - 0.5
            
            // Bonus for previous visits (loyalty effect)
            const loyaltyBonus = Math.min(0.3, visits * 0.1); // Up to 0.3 for 3+ visits
            
            // Reputation bonus
            const reputationBonus = (gameState.company.reputation - 3) / 10; // 0-0.2 for reputation 3-5
            
            return Math.min(0.9, baseChance + loyaltyBonus + reputationBonus);
        }

        // Helper function to generate review comments
        function generateReviewComment(rating, subject) {
            const positiveComments = [
    "Excellent tutoring in ${subject}. Really helped me understand the concepts.",
    "The tutor was very patient and explained ${subject} clearly.",
    "My grades in ${subject} improved dramatically!",
    "Professional and knowledgeable about ${subject}. Highly recommend!",
    "Great teaching methods. Made ${subject} interesting and easy to understand.",
    "The tutor made complex topics feel approachable and fun to learn.",
    "I’ve gained so much confidence in my studies thanks to these sessions.",
    "Fantastic guidance—everything was broken down into simple steps.",
    "The tutor’s enthusiasm really kept me motivated throughout our lessons.",
    "Incredible support that turned my weaknesses into strengths.",
    "Lessons were engaging, and I looked forward to every session.",
    "The tutor’s expertise made a huge difference in my understanding.",
    "Clear, patient, and inspiring—couldn’t ask for a better experience."
];

const neutralComments = [
    "Decent tutoring service for ${subject}.",
    "Helped with my ${subject} homework, but could improve explanations.",
    "Good teaching but sessions felt a bit rushed.",
    "The tutor knows ${subject} well, but teaching style didn’t fully suit me.",
    "Acceptable service. My understanding of ${subject} has improved somewhat.",
    "The sessions were helpful, though sometimes lacked a bit of depth.",
    "Solid tutoring, but I’d prefer a slightly slower pace.",
    "The tutor was knowledgeable, yet the approach felt a little generic.",
    "I learned some useful tips, but the impact wasn’t as strong as expected.",
    "Decent effort from the tutor, though the sessions were hit-or-miss.",
    "The lessons were fine—just didn’t fully click with my learning style.",
    "Got through the material okay, but it felt a bit routine.",
    "The tutor was competent, though I hoped for more personalized feedback."
];

const negativeComments = [
    "Struggled to explain ${subject} concepts clearly.",
    "Tutor was often distracted during our ${subject} sessions.",
    "Didn’t see much improvement in my ${subject} grades.",
    "Teaching methods for ${subject} were confusing.",
    "Session felt disorganized. Not sure if I’ll return for ${subject} help.",
    "The sessions lacked structure and left me more confused than before.",
    "Tutor seemed unprepared and didn’t address my questions well.",
    "I didn’t feel any real progress despite multiple lessons.",
    "The teaching was too rushed, making it hard to keep up.",
    "Disappointing experience—felt like my needs were overlooked.",
    "Tutor’s explanations were vague and hard to follow.",
    "The sessions were uninspiring and didn’t motivate me to improve.",
    "Poor communication made the lessons frustrating and unproductive."
];
            
            if (rating >= 4) {
                return getRandomElement(positiveComments);
            } else if (rating >= 3) {
                return getRandomElement(neutralComments);
            } else {
                return getRandomElement(negativeComments);
            }
        }

        // Calculate company reputation dynamically
        function updateCompanyReputation() {
            // Components for reputation calculation
            let sessionSuccess = 0;
            let teacherSatisfaction = 0;
            let studentRatings = 0;
            
            // Session success (on-time completion rate, 0-1)
            if (gameState.completedSessions.length > 0) {
                const onTimeCount = gameState.completedSessions.filter(s => s.isOnTime).length;
                sessionSuccess = onTimeCount / gameState.completedSessions.length;
            }
            
            // Teacher satisfaction (average loyalty, 0-1)
            if (gameState.teachers.length > 0) {
                const totalLoyalty = gameState.teachers.reduce((sum, t) => sum + t.loyalty, 0);
                teacherSatisfaction = totalLoyalty / (gameState.teachers.length * 100);
                
                // Update UI stat
                gameState.stats.teacherSatisfaction = Math.round(teacherSatisfaction * 100);
            }
            
            // Student ratings (average rating, 0-1)
            if (gameState.studentReviews.length > 0) {
                const totalRating = gameState.studentReviews.reduce((sum, r) => sum + r.rating, 0);
                studentRatings = totalRating / (gameState.studentReviews.length * 5);
            }
            
            // Calculate weighted reputation (1-5 scale)
            const newReputation = (
                (sessionSuccess * 1.5) + 
                (teacherSatisfaction * 2) + 
                (studentRatings * 1.5)
            ) / 5 * 5;
            
            // Smooth the transition to avoid jarring changes
            const oldReputation = gameState.company.reputation;
            gameState.company.reputation = oldReputation * 0.8 + newReputation * 0.2;
            
            // Keep within bounds
            gameState.company.reputation = Math.max(1, Math.min(5, gameState.company.reputation));
            
            // Update UI
            updateCompanyInfo();
        }

        function hireTeacher(applicantId) {
            const applicantIndex = gameState.applicants.findIndex(applicant => applicant.id === applicantId);
            
            if (applicantIndex === -1) return null;
            
            const teacher = gameState.applicants[applicantIndex];
            
            // Check if we can afford the teacher
            if (teacher.salary > gameState.company.capital) {
                addNotification(`Not enough capital to hire ${teacher.name}.`, "error");
                return null;
            }
            
            // Check if we have capacity for more teachers
            if (gameState.teachers.length >= gameState.company.teacherCapacity) {
                addNotification(`You've reached your teacher capacity (${gameState.company.teacherCapacity}). Expand your office to hire more teachers.`, "error");
                return null;
            }
            
            // Update teacher
            teacher.available = isTeacherAvailable(teacher);
            teacher.hireDate = new Date();
            teacher.lastFatigueUpdate = new Date(); // Initialize fatigue recovery timer
            
            // Add to teachers list
            gameState.teachers.push(teacher);
            
            // Remove from applicants list
            gameState.applicants.splice(applicantIndex, 1);
            
            // Update UI
            updateTeachersCount();
            renderTeachersList();
            renderApplicantsList();
            
            // Add notification
            addNotification(`${teacher.name} hired successfully.`, "success");
            
            return teacher;
        }

        // Function to update teacher salary - new implementation
        function updateTeacherSalary(teacherId, newSalary) {
            const teacher = gameState.teachers.find(teacher => teacher.id === teacherId);
            
            if (!teacher) return null;
            
            // Validate salary range
            if (newSalary < 300) newSalary = 300;
            if (newSalary > 2000) newSalary = 2000;
            
            const oldSalary = teacher.salary;
            teacher.salary = newSalary;
            
            // Adjust company finances
            const salaryDifference = newSalary - oldSalary;
            
            // Update loyalty based on salary change
            if (newSalary > oldSalary) {
                const loyaltyGain = Math.ceil((newSalary - oldSalary) / 100);
                teacher.loyalty += loyaltyGain;
                addNotification(`${teacher.name}'s loyalty increased by ${loyaltyGain} points.`, "success");
            } else if (newSalary < oldSalary) {
                const loyaltyLoss = Math.ceil((oldSalary - newSalary) / 75);
                teacher.loyalty -= loyaltyLoss;
                addNotification(`${teacher.name}'s loyalty decreased by ${loyaltyLoss} points.`, "warning");
            }
            
            teacher.loyalty = Math.max(0, Math.min(100, teacher.loyalty));
            
            // Update teacher risk/disengaged status based on loyalty
            teacher.risk = teacher.loyalty < 30;
            teacher.disengaged = teacher.loyalty < 50;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Salary Adjustment",
                details: `Adjusted ${teacher.name}'s salary from $${formatCurrency(oldSalary)} to $${formatCurrency(newSalary)}`,
                impact: salaryDifference > 0 ? `Weekly cost: +$${formatCurrency(salaryDifference)}` : `Weekly savings: $${formatCurrency(-salaryDifference)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            renderTeachersList();
            
            return {
                teacher,
                oldSalary,
                newSalary,
                change: salaryDifference
            };
        }

        function renameTeacher(teacherId, newName) {
            const teacher = gameState.teachers.find(teacher => teacher.id === teacherId);
            
            if (!teacher) return null;
            
            teacher.name = newName;
            
            // Update UI
            renderTeachersList();
            
            return teacher;
        }

        // Set or remove student nickname
        function updateStudentNickname(studentId, nickname) {
            const student = gameState.availableStudents.find(s => s.id === studentId);
            
            if (!student) return false;
            
            student.nickname = nickname;
            renderStudentsList();
            
            return true;
        }

        // New function for teacher termination
        function terminateTeacher(teacherId) {
            const teacherIndex = gameState.teachers.findIndex(t => t.id === teacherId);
            
            if (teacherIndex === -1) return false;
            
            const teacher = gameState.teachers[teacherIndex];
            
            // Calculate termination fee (2 weeks salary)
            const terminationFee = teacher.salary * 2;
            
            // Check if we can afford the termination fee
            if (terminationFee > gameState.company.capital) {
                addNotification(`Not enough capital to pay termination fee of $${formatCurrency(terminationFee)}.`, "error");
                return false;
            }
            
            // Deduct termination fee
            gameState.company.capital -= terminationFee;
            
            // Decrease company reputation
            gameState.company.reputation = Math.max(1, gameState.company.reputation - 0.2);
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Teacher Termination",
                details: `Terminated ${teacher.name}'s employment`,
                impact: `-$${formatCurrency(terminationFee)} termination fee, -0.2 reputation`
            };
            gameState.company.history.push(event);
            
            // Remove from teachers list
            gameState.teachers.splice(teacherIndex, 1);
            
            // Add notification
            addNotification(`${teacher.name}'s employment has been terminated.`, "warning");
            
            // Update UI
            updateTeachersCount();
            renderTeachersList();
            updateCompanyInfo();
            
            return true;
        }

        function upgradeSessionQuota() {
            const upgradeCost = gameState.company.quotaUpgradeCost;
            
            if (gameState.company.capital < upgradeCost) {
                addNotification(`Not enough capital to upgrade session quota ($${formatCurrency(upgradeCost)}).`, "error");
                return false;
            }
            
            // Update company stats
            gameState.company.capital -= upgradeCost;
            gameState.company.quota += 5;
            
            // Increase cost for next upgrade (50% more)
            gameState.company.quotaUpgradeCost = Math.round(upgradeCost * 1.5);
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Session Quota Upgraded",
                details: `Increased daily session quota to ${gameState.company.quota}`,
                impact: `-$${formatCurrency(upgradeCost)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateCompanyInfo();
            
            // Add notification
            addNotification(`Daily session quota increased to ${gameState.company.quota}.`, "success");
            
            return true;
        }

        // Teacher lounge upgrade
        function upgradeTeacherLounge() {
            const upgradeCost = gameState.company.teacherLoungeCost;
            
            if (gameState.company.capital < upgradeCost) {
                addNotification(`Not enough capital to upgrade teacher lounge ($${formatCurrency(upgradeCost)}).`, "error");
                return false;
            }
            
            // Check if already at max level
            if (gameState.company.teacherLoungeLevel >= 5) {
                addNotification(`Teacher lounge is already at maximum level.`, "error");
                return false;
            }
            
            // Update company stats
            gameState.company.capital -= upgradeCost;
            gameState.company.teacherLoungeLevel++;
            gameState.company.teacherLoungeEffect += 5; // Each level adds 5% reduction
            
            // Increase cost for next upgrade (50% more)
            gameState.company.teacherLoungeCost = Math.round(upgradeCost * 1.5);
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Teacher Lounge Upgraded",
                details: `Upgraded teacher lounge to level ${gameState.company.teacherLoungeLevel}`,
                impact: `-$${formatCurrency(upgradeCost)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateUpgradesInfo();
            
            // Add notification
            addNotification(`Teacher lounge upgraded to level ${gameState.company.teacherLoungeLevel}. Loyalty decay reduced by ${gameState.company.teacherLoungeEffect}%.`, "success");
            
            return true;
        }

        // Office expansion for teacher capacity
        function upgradeOffice() {
            const upgradeCost = gameState.company.officeUpgradeCost;
            
            if (gameState.company.capital < upgradeCost) {
                addNotification(`Not enough capital to expand office ($${formatCurrency(upgradeCost)}).`, "error");
                return false;
            }
            
            // Update company stats
            gameState.company.capital -= upgradeCost;
            gameState.company.teacherCapacity += 2; // Each upgrade adds 2 slots
            
            // Increase cost for next upgrade (50% more)
            gameState.company.officeUpgradeCost = Math.round(upgradeCost * 1.5);
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Office Expanded",
                details: `Expanded office to accommodate ${gameState.company.teacherCapacity} teachers`,
                impact: `-$${formatCurrency(upgradeCost)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateUpgradesInfo();
            updateTeachersCount();
            
            // Add notification
            addNotification(`Office expanded! You can now hire up to ${gameState.company.teacherCapacity} teachers.`, "success");
            
            return true;
        }

        // Host a workshop to boost teacher loyalty and skills
        function hostWorkshop() {
            const workshopCost = 1000;
            
            if (gameState.company.capital < workshopCost) {
                addNotification(`Not enough capital to host workshop ($${formatCurrency(workshopCost)}).`, "error");
                return false;
            }
            
            // Check if already hosted workshop today
            const currentDay = gameState.time.day;
            if (gameState.marketing.lastWorkshopDay === currentDay) {
                addNotification(`You can only host one workshop per day.`, "error");
                return false;
            }
            
            // Check if it's 9 PM
            const currentHour = new Date().getHours();
            if (currentHour !== 21) {
                addNotification(`Workshops can only be hosted at 9 PM (current time: ${currentHour}:00).`, "error");
                return false;
            }
            
            // Check if we have teachers
            if (gameState.teachers.length === 0) {
                addNotification(`You don't have any teachers to attend the workshop.`, "error");
                return false;
            }
            
            // Deduct cost
            gameState.company.capital -= workshopCost;
            
            // Track that we hosted a workshop today
            gameState.marketing.lastWorkshopDay = currentDay;
            
            // Apply effects to all teachers
            const skillImprovedTeachers = [];
            
            gameState.teachers.forEach(teacher => {
                // Boost loyalty
                const oldLoyalty = teacher.loyalty;
                teacher.loyalty = Math.min(100, teacher.loyalty + 5);
                
                // 10% chance to improve skills
                if (Math.random() < 0.1) {
                    // Choose a random skill to improve
                    const skillKeys = ["onlineTeaching", "groupTeaching", "specialNeeds", "teachingEfficiency"];
                    const randomSkill = getRandomElement(skillKeys);
                    
                    // Improve by 1-2 points
                    const improvementAmount = getRandomInt(1, 2);
                    
                    // Only improve if below 10
                    if (teacher.skills[randomSkill] < 10) {
                        teacher.skills[randomSkill] = Math.min(10, teacher.skills[randomSkill] + improvementAmount);
                        skillImprovedTeachers.push({
                            name: teacher.name,
                            skill: randomSkill.replace(/([A-Z])/g, ' $1').toLowerCase(),
                            amount: improvementAmount
                        });
                    }
                }
            });
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Teacher Workshop",
                details: `Hosted a professional development workshop`,
                impact: `-$${formatCurrency(workshopCost)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            renderTeachersList();
            
            // Notifications
            addNotification(`Workshop hosted successfully! All teachers gained 5% loyalty.`, "success");
            
            // Notify about skill improvements
            skillImprovedTeachers.forEach(improvement => {
                addNotification(`${improvement.name}'s ${improvement.skill} skill improved by ${improvement.amount} points!`, "success");
            });
            
            return true;
        }

        // Unlock marketing functionality
        function unlockMarketing() {
            const unlockCost = 5000;
            
            if (gameState.company.capital < unlockCost) {
                addNotification(`Not enough capital to unlock marketing ($${formatCurrency(unlockCost)}).`, "error");
                return false;
            }
            
            // Update company stats
            gameState.company.capital -= unlockCost;
            gameState.company.marketingUnlocked = true;
            gameState.marketing.unlocked = true;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Marketing Unlocked",
                details: `Unlocked marketing campaigns functionality`,
                impact: `-$${formatCurrency(unlockCost)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateMarketingContent();
            
            // Add notification
            addNotification(`Marketing campaigns unlocked! You can now run marketing campaigns to attract more students.`, "success");
            
            return true;
        }

        // Start a marketing campaign
function startMarketingCampaign(campaignType) {
    // Check if marketing is unlocked
    if (!gameState.marketing.unlocked) {
        addNotification(`Marketing campaigns are not unlocked yet.`, "error");
        return false;
    }
    
    // Check if there's already an active campaign
    if (gameState.marketing.activeCampaign) {
        addNotification(`There's already an active campaign.`, "error");
        return false;
    }
    
    // Get campaign details
    const campaign = marketingCampaigns[campaignType];
    if (!campaign) {
        addNotification(`Invalid campaign type.`, "error");
        return false;
    }
    
    // Check if we can afford it
    if (gameState.company.capital < campaign.cost) {
        addNotification(`Not enough capital to start ${campaign.name} campaign ($${formatCurrency(campaign.cost)}).`, "error");
        return false;
    }
    
    // Deduct cost
    gameState.company.capital -= campaign.cost;
    gameState.marketing.totalSpend += campaign.cost;
    
    // Set up active campaign
    const startDate = new Date();
    const endDate = new Date(startDate.getTime() + (campaign.duration * 24 * 60 * 60 * 1000));
    
    gameState.marketing.activeCampaign = {
        type: campaignType,
        name: campaign.name,
        description: campaign.description,
        cost: campaign.cost,
        studentIncrease: campaign.studentIncrease,
        startDate,
        endDate,
        studentsGained: 0,
        revenue: 0
    };
    
    // Update max student increase
    gameState.marketing.maxStudentIncrease = campaign.studentIncrease;
    
    // Reset campaign tracking variables
    gameState.marketing.studentsGained = 0;
    gameState.marketing.totalRevenue = 0;
    
    // Add to company history
    const event = {
        date: new Date(),
        event: "Marketing Campaign",
        details: `Started ${campaign.name} marketing campaign`,
        impact: `-$${formatCurrency(campaign.cost)}`
    };
    gameState.company.history.push(event);
    
    // Schedule campaign completion
    setTimeout(() => {
        let studentIncrease;
        switch (campaignType) {
            case 'social': studentIncrease = Math.ceil(Math.random() * 1); break;
            case 'flyers': studentIncrease = Math.ceil(Math.random() * 3); break;
            case 'fair': studentIncrease = Math.ceil(Math.random() * 5); break;
        }
        
        generateStudents(studentIncrease);
        addNotification(`Marketing campaign "${campaign.name}" completed! Gained ${studentIncrease} new student${studentIncrease > 1 ? 's' : ''}.`, "success");
        
        // Reset active campaign
        gameState.marketing.activeCampaign = null;

        // Update UI
        updateMarketingContent();
        updateStudentsCount();
        renderStudentsList();
    }, campaign.duration * 24 * 60 * 60 * 1000); // Duration in milliseconds
}

        // Complete a marketing campaign
        function completeMarketingCampaign() {
            if (!gameState.marketing.activeCampaign) return false;
            
            const campaign = gameState.marketing.activeCampaign;
            
            // Calculate ROI
            const revenue = gameState.marketing.totalRevenue;
            const cost = campaign.cost;
            const roi = cost > 0 ? ((revenue - cost) / cost) * 100 : 0;
            
            // Create campaign history record
            const campaignRecord = {
                type: campaign.type,
                name: campaign.name,
                cost: campaign.cost,
                studentsGained: gameState.marketing.studentsGained,
                revenue: revenue,
                roi: Math.round(roi),
                startDate: campaign.startDate,
                endDate: new Date()
            };
            
            // Add to campaign history
            gameState.marketing.campaignHistory.unshift(campaignRecord);
            
            // Clean up
            gameState.marketing.activeCampaign = null;
            gameState.marketing.maxStudentIncrease = 0;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Marketing Campaign Completed",
                details: `Completed ${campaign.name} marketing campaign`,
                impact: `+${gameState.marketing.studentsGained} students, ROI: ${Math.round(roi)}%`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateMarketingContent();
            
            // Add notification
            addNotification(`${campaign.name} campaign completed! Gained ${gameState.marketing.studentsGained} students with ${Math.round(roi)}% ROI.`, roi >= 0 ? "success" : "warning");
            
            return true;
        }

        function seekInvestment() {
            if (gameState.company.reputation < 4.0) {
                addNotification("Company reputation too low to attract investors.", "error");
                return false;
            }
            
            const investmentAmount = 50000;
            
            // Update company stats
            gameState.company.capital += investmentAmount;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Investment Received",
                details: "External investment secured",
                impact: `+$${formatCurrency(investmentAmount)}`
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateCompanyInfo();
            
            // Add notification
            addNotification(`Received $${formatCurrency(investmentAmount)} investment.`, "success");
            
            return true;
        }

        function renameCompany(newName) {
            gameState.company.name = newName;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Company Renamed",
                details: `Company renamed to ${newName}`,
                impact: "No financial impact"
            };
            gameState.company.history.push(event);
            
            // Update UI
            updateCompanyInfo();
            
            return true;
        }

        // Process fatigue recovery
        function processFatigueRecovery() {
            const now = new Date();
            
            gameState.teachers.forEach(teacher => {
                if (teacher.active) return; // Skip active teachers
                
                const lastUpdate = teacher.lastFatigueUpdate || now;
                const hoursSinceLastUpdate = (now - lastUpdate) / (1000 * 60 * 60);
                
                if (hoursSinceLastUpdate < 0.25) return; // Only process every 15 mins of game time
                
                let recoveryRate = 1.0; // Base recovery rate per hour
                
                // Higher recovery during off-hours
                const currentHour = now.getHours();
                const workStart = parseInt(teacher.workingHours.start.split(':')[0]);
                const workEnd = parseInt(teacher.workingHours.end.split(':')[0]);
                
                const isWorkingHours = (workEnd > workStart) 
                    ? (currentHour >= workStart && currentHour < workEnd)
                    : (currentHour >= workStart || currentHour < workEnd);
                
                if (!isWorkingHours) {
                    recoveryRate *= 1.5; // 50% faster recovery during off-hours
                }
                
                // Higher recovery on weekends
                if (isWeekend()) {
                    recoveryRate *= 2.0; // Double recovery on weekends
                }
                
                // Apply teacher's personal recovery rate modifier
                recoveryRate *= (teacher.fatigueRecoveryRate || 1.0);
                
                // Calculate fatigue reduction
                const fatigueReduction = Math.floor(recoveryRate * hoursSinceLastUpdate);
                
                if (fatigueReduction > 0 && teacher.fatigue > 0) {
                    const oldFatigue = teacher.fatigue;
                    teacher.fatigue = Math.max(0, teacher.fatigue - fatigueReduction);
                    teacher.lastFatigueUpdate = now;
                    
                    // Only update UI if there was a significant change
                    if (oldFatigue - teacher.fatigue >= 5) {
                        renderTeachersList();
                    }
                }
            });
        }

        // Process weekly expenses
        function processWeeklyExpenses() {
            const expenses = gameState.company.expenses;
            const totalWeeklyExpenses = 
                expenses.rent + 
                expenses.utilities + 
                expenses.insurance + 
                expenses.advertising + 
                expenses.adminStaff;
            
            // Add teacher salaries
            const totalTeacherSalaries = gameState.teachers.reduce((total, teacher) => total + teacher.salary, 0);
            const totalExpenses = totalWeeklyExpenses + totalTeacherSalaries;
            
            // Deduct from capital
            gameState.company.capital -= totalExpenses;
            gameState.company.operatingExpenses += totalExpenses;
            
            // Update weekly tracking
            gameState.company.weeklyStats.expenses += totalExpenses;
            gameState.company.weeklyStats.profit = gameState.company.weeklyStats.revenue - gameState.company.weeklyStats.expenses;
            
            // Add to company history
            const event = {
                date: new Date(),
                event: "Weekly Expenses",
                details: `Operating expenses: $${formatCurrency(totalWeeklyExpenses)}, Teacher salaries: $${formatCurrency(totalTeacherSalaries)}`,
                impact: `-$${formatCurrency(totalExpenses)}`
            };
            gameState.company.history.push(event);
            
            // Notify the player
            addNotification(`Weekly expenses: -$${formatCurrency(totalExpenses)} (including teacher salaries)`, "info");
            
            // Update UI
            updateCompanyInfo();
            updateDashboardStats();
            
            return totalExpenses;
        }

        // Reset weekly financial tracking
        function resetWeeklyStats() {
            // Store last week's data for comparative analytics
            const lastWeekData = {
                revenue: gameState.company.weeklyStats.revenue,
                expenses: gameState.company.weeklyStats.expenses,
                profit: gameState.company.weeklyStats.profit
            };
            
            // Reset weekly counters
            gameState.company.weeklyStats.revenue = 0;
            gameState.company.weeklyStats.expenses = 0;
            gameState.company.weeklyStats.profit = 0;
            gameState.company.weeklyStats.lastWeekReset = new Date();
            
            // Reset student acquisition count
            gameState.stats.studentAcquisition = 0;
            
            // Update UI elements
            document.getElementById("weekly-revenue").textContent = "0.00";
            document.getElementById("weekly-expenses").textContent = "0.00";
            document.getElementById("weekly-profit").textContent = "0.00";
            
            // Update progress bars
            document.getElementById("revenue-bar").style.width = "0%";
            document.getElementById("expenses-bar").style.width = "0%";
            document.getElementById("profit-bar").style.width = "0%";
            
            return lastWeekData;
        }

        // Process teacher loyalty decay
        function processTeacherLoyaltyDecay() {
            const now = new Date();
            const decayReduction = gameState.company.teacherLoungeEffect / 100; // Effect of teacher lounge
            
            gameState.teachers.forEach(teacher => {
                // Check for inactivity (no sessions in a week)
                const daysSinceLastSession = (now - teacher.lastSessionDate) / (1000 * 60 * 60 * 24);
                
                if (daysSinceLastSession >= 7) {
                    // Apply weekly inactivity penalty (-5%)
                    const decayAmount = 5 * (1 - decayReduction); // Reduced by lounge effect
                    teacher.loyalty = Math.max(0, teacher.loyalty - decayAmount);
                    
                    // Update teacher states
                    teacher.risk = teacher.loyalty < 30;
                    teacher.disengaged = teacher.loyalty < 50;
                }
                
                // Check for teacher quitting (if loyalty < 30%)
                if (teacher.loyalty < 30 && Math.random() < 0.1) { // 10% weekly chance
                    // Teacher quits
                    const teacherIndex = gameState.teachers.indexOf(teacher);
                    if (teacherIndex !== -1) {
                        gameState.teachers.splice(teacherIndex, 1);
                        
                        // Add notification
                        addNotification(`${teacher.name} has quit due to low loyalty!`, "error");
                        
                        // Add to company history
                        const event = {
                            date: new Date(),
                            event: "Teacher Quit",
                            details: `${teacher.name} quit due to low loyalty`,
                            impact: "Reputation -0.1"
                        };
                        gameState.company.history.push(event);
                        
                        // Slight reputation hit
                        gameState.company.reputation = Math.max(1, gameState.company.reputation - 0.1);
                    }
                }
            });
            
            // Update UI
            renderTeachersList();
            updateTeachersCount();
        }

        // Check for teacher overstaffing loyalty penalty
        function processOverstaffingPenalty() {
            const teacherCount = gameState.teachers.length;
            const capacity = gameState.company.teacherCapacity;
            
            if (teacherCount > capacity) {
                const overstaffedTeachers = teacherCount - capacity;
                
                // Apply weekly loyalty penalty to all teachers (-15%)
                gameState.teachers.forEach(teacher => {
                    teacher.loyalty = Math.max(0, teacher.loyalty - 15);
                    
                    // Update teacher states
                    teacher.risk = teacher.loyalty < 30;
                    teacher.disengaged = teacher.loyalty < 50;
                });
                
                // Add notification
                addNotification(`Overstaffing penalty: ${overstaffedTeachers} teachers over capacity. All teachers lost 15% loyalty!`, "error");
                
                // Update UI
                renderTeachersList();
            }
        }

        // Check for expired students
        function checkExpiredStudents() {
            const now = new Date();
            const expiredStudents = gameState.availableStudents.filter(student => student.deadline < now);
            
            if (expiredStudents.length > 0) {
                // Remove expired students
                gameState.availableStudents = gameState.availableStudents.filter(student => student.deadline >= now);
                
                // Add notifications
                expiredStudents.forEach(student => {
                    const studentName = student.nickname || student.name;
                    addNotification(`Student ${studentName}'s request for ${student.subject.name} tutoring has expired. Opportunity lost!`, "warning");
                });
                
                // Update UI
                updateStudentsCount();
                renderStudentsList();
                
                // For analytics tracking
                return expiredStudents.length;
            }
            
            return 0;
        }

        // Check if it's time to process a new day
        function processDayChange() {
            const now = new Date();
            const todayDateStr = now.toDateString();
            
            // If we haven't processed this day yet
            if (gameState.time.lastDayProcessed !== todayDateStr) {
                gameState.time.lastDayProcessed = todayDateStr;
                gameState.time.day++;
                gameState.time.dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
                
                // If it's Sunday (dayOfWeek = 0), process weekly changes
                if (gameState.time.dayOfWeek === 0) {
                    gameState.time.week++;
                    processWeeklyExpenses();
                    processTeacherLoyaltyDecay();
                    processOverstaffingPenalty();
                    
                    // If it's been a week since last reset
                    const lastReset = gameState.company.weeklyStats.lastWeekReset;
                    const weeksSinceReset = Math.floor((now - lastReset) / (7 * 24 * 60 * 60 * 1000));
                    
                    if (weeksSinceReset >= 1) {
                        resetWeeklyStats();
                    }
                    
                    addNotification(`Week ${gameState.time.week} has begun.`, "info");
                }
                
                // Check marketing campaign if active
                if (gameState.marketing.activeCampaign) {
                    const campaign = gameState.marketing.activeCampaign;
                    if (now >= campaign.endDate) {
                        completeMarketingCampaign();
                    }
                }
                
                return true;
            }
            
            return false;
        }

        function addNotification(message, type = "info") {
            const notification = {
                id: Date.now(),
                message,
                type,
                time: new Date()
            };
            
            gameState.notifications.unshift(notification);
            
            // Keep only the most recent 10 notifications
            if (gameState.notifications.length > 10) {
                gameState.notifications.pop();
            }
            
            // Update notification UI
            updateNotificationIndicator();
            
            // Show toast notification
            showToast(message, type);
            
            return notification;
        }

        function showToast(message, type = "info") {
            const toastContainer = document.getElementById("toast-container");
            const id = Date.now();
            
            let bgColor, iconClass;
            switch (type) {
                case "success":
                    bgColor = "bg-green-500";
                    iconClass = "fas fa-check-circle";
                    break;
                case "warning":
                    bgColor = "bg-yellow-500";
                    iconClass = "fas fa-exclamation-triangle";
                    break;
                case "error":
                    bgColor = "bg-red-500";
                    iconClass = "fas fa-times-circle";
                    break;
                default:
                    bgColor = "bg-blue-500";
                    iconClass = "fas fa-info-circle";
            }
            
            const toast = document.createElement("div");
            toast.id = `toast-${id}`;
            toast.className = `${bgColor} text-white p-4 rounded-lg shadow-lg flex items-start animate-fadeIn max-w-md`;
            toast.innerHTML = `
                <div class="flex-shrink-0 mr-3">
                    <i class="${iconClass}"></i>
                </div>
                <div class="flex-1">
                    <p>${message}</p>
                </div>
                <button class="ml-4 text-white hover:text-gray-200" onclick="document.getElementById('toast-${id}').remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove toast after 5 seconds
            setTimeout(() => {
                const toastElement = document.getElementById(`toast-${id}`);
                if (toastElement) {
                    toastElement.classList.add("opacity-0");
                    setTimeout(() => toastElement.remove(), 300);
                }
            }, 5000);
        }

        // Save Game Functions
        function saveGame() {
            try {
                const saveData = exportGameData();
                
                // Check if localStorage is available
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('eduMasterSaveData', saveData);
                    
                    // Show save indicator
                    const saveIndicator = document.getElementById('save-indicator');
                    saveIndicator.classList.add('show');
                    setTimeout(() => {
                        saveIndicator.classList.remove('show');
                    }, 2000);
                    
                    return true;
                } else {
                    console.log("Local storage not available for auto-save");
                    return false;
                }
            } catch (error) {
                console.error("Error saving game:", error);
                return false;
            }
        }

        function loadSavedGame() {
            try {
                if (typeof localStorage !== 'undefined') {
                    const savedData = localStorage.getItem('eduMasterSaveData');
                    if (savedData) {
                        return importGameData(savedData);
                    }
                }
            } catch (error) {
                console.error("Error loading saved game:", error);
            }
            return false;
        }

        // Auto-save function
        function setupAutoSave() {
            // Auto-save every 10 minutes
            const autoSaveInterval = 10 * 60 * 1000; // 10 minutes in milliseconds
            
            setInterval(() => {
                const now = new Date();
                
                // Initialize lastAutoSave if it doesn't exist
                if (!gameState.time.lastAutoSave) {
                    gameState.time.lastAutoSave = now;
                }
                
                const timeSinceLastSave = now - gameState.time.lastAutoSave;
                
                // Only save if enough time has passed
                if (timeSinceLastSave >= autoSaveInterval) {
                    if (saveGame()) {
                        gameState.time.lastAutoSave = now;
                        console.log("Game auto-saved");
                    }
                }
            }, 60000); // Check every minute
        }

        // Reset game function
        function resetGame() {
            // Clear localStorage if it's available
            if (typeof localStorage !== 'undefined') {
                localStorage.removeItem('eduMasterSaveData');
            }
            
            // Reset game state to initial values
            gameState.company = {
                name: "EduMaster Tutoring",
                founded: new Date(),
                capital: 30000,
                reputation: 3.5,
                quota: 10,
                quotaUpgradeCost: 5000,
                teacherCapacity: 5,
                officeUpgradeCost: 10000,
                teacherLoungeLevel: 0,
                teacherLoungeCost: 5000,
                teacherLoungeEffect: 0,
                marketingUnlocked: false,
                sessionsCompleted: 0,
                totalRevenue: 0,
                teacherPayments: 0,
                operatingExpenses: 0,
                netProfit: 0,
                history: [],
                expenses: {
                    rent: 300,
                    utilities: 75,
                    insurance: 62.5,
                    advertising: 125,
                    adminStaff: 500
                },
                weeklyStats: {
                    revenue: 0,
                    expenses: 0,
                    profit: 0,
                    lastWeekReset: new Date()
                },
            };
            
            gameState.marketing = {
                unlocked: false,
                activeCampaign: null,
                maxStudentIncrease: 0,
                campaignHistory: [],
                totalSpend: 0,
                totalRevenue: 0,
                studentsGained: 0,
                lastWorkshopDay: -1,
            };
            
            gameState.time = {
                day: 0,
                dayOfWeek: new Date().getDay(),
                week: 0,
                lastDayProcessed: new Date().toDateString(),
                hoursPassed: 0,
                lastAutoSave: null,
            };
            
            gameState.teachers = [];
            gameState.applicants = [];
            gameState.availableStudents = [];
            gameState.activeSessions = [];
            gameState.completedSessions = [];
            gameState.returningStudents = [];
            gameState.studentReviews = [];
            
            gameState.stats = {
                dailyEarnings: 0,
                weeklyEarnings: [0, 0, 0, 0, 0, 0, 0],
                monthlyEarnings: Array(30).fill(0),
                teacherSatisfaction: 85,
                onTimeRate: 92,
                totalHours: 0,
                studentAcquisition: 0,
                retentionRate: 0
            };
            
            gameState.notifications = [];
            
            // Regenerate initial content
            generateStudents(5);
            generateApplicants(3);
            
            // Reset UI
            initializeUI();
            
            // Add notification
            addNotification("Game has been reset to the beginning.", "info");
            
            return true;
        }

        // Data Export/Import Functions
        function exportGameData() {
            try {
                const gameDataStr = JSON.stringify(gameState);
                return btoa(gameDataStr);
            } catch (error) {
                console.error("Error exporting game data:", error);
                return null;
            }
        }

        function importGameData(dataString) {
            try {
                const jsonStr = atob(dataString);
                const importedState = JSON.parse(jsonStr);
                
                // Validate the imported data
                if (!importedState || !importedState.company || !importedState.teachers) {
                    throw new Error("Invalid game data format");
                }
                
                // Convert date strings back to Date objects
                importedState.company.founded = new Date(importedState.company.founded);
                importedState.company.weeklyStats.lastWeekReset = new Date(importedState.company.weeklyStats.lastWeekReset);
                
                importedState.time.lastDayProcessed = importedState.time.lastDayProcessed ? 
                    new Date(importedState.time.lastDayProcessed).toDateString() : null;
                
                if (importedState.time.lastAutoSave) {
                    importedState.time.lastAutoSave = new Date(importedState.time.lastAutoSave);
                }
                
                // Process teachers
                importedState.teachers.forEach(teacher => {
                    teacher.hireDate = new Date(teacher.hireDate);
                    teacher.lastFatigueUpdate = new Date(teacher.lastFatigueUpdate);
                    teacher.lastSessionDate = new Date(teacher.lastSessionDate);
                });
                
                // Process students
                importedState.availableStudents.forEach(student => {
                    student.createdAt = new Date(student.createdAt);
                    student.deadline = new Date(student.deadline);
                });
                
                // Process active sessions
                importedState.activeSessions.forEach(session => {
                    session.startTime = new Date(session.startTime);
                    session.estimatedEnd = new Date(session.estimatedEnd);
                    session.adjustedEnd = new Date(session.adjustedEnd);
                    if (session.completedAt) {
                        session.completedAt = new Date(session.completedAt);
                    }
                    session.student.createdAt = new Date(session.student.createdAt);
                    session.student.deadline = new Date(session.student.deadline);
                });
                
                // Process completed sessions
                importedState.completedSessions.forEach(session => {
                    session.startTime = new Date(session.startTime);
                    session.estimatedEnd = new Date(session.estimatedEnd);
                    session.adjustedEnd = new Date(session.adjustedEnd);
                    session.completedAt = new Date(session.completedAt);
                    session.student.createdAt = new Date(session.student.createdAt);
                    session.student.deadline = new Date(session.student.deadline);
                });
                
                // Process student reviews
                importedState.studentReviews.forEach(review => {
                    review.date = new Date(review.date);
                });
                
                // Process company history
                importedState.company.history.forEach(event => {
                    event.date = new Date(event.date);
                });
                
                // Process marketing campaign if active
                if (importedState.marketing && importedState.marketing.activeCampaign) {
                    importedState.marketing.activeCampaign.startDate = new Date(importedState.marketing.activeCampaign.startDate);
                    importedState.marketing.activeCampaign.endDate = new Date(importedState.marketing.activeCampaign.endDate);
                }
                
                // Process campaign history if exists
                if (importedState.marketing && importedState.marketing.campaignHistory) {
                    importedState.marketing.campaignHistory.forEach(campaign => {
                        campaign.startDate = new Date(campaign.startDate);
                        campaign.endDate = new Date(campaign.endDate);
                    });
                }
                
                // Apply the imported state
                Object.assign(gameState, importedState);
                
                // Reset any active UI elements
                initializeUI();
                
                return true;
            } catch (error) {
                console.error("Error importing game data:", error);
                return false;
            }
        }

        // UI Update functions
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById("current-time").textContent = timeStr;
        }

        function updateCompanyInfo() {
            document.getElementById("company-name").textContent = gameState.company.name;
            document.getElementById("company-capital").textContent = `$${formatCurrency(gameState.company.capital)}`;
            document.getElementById("company-founded").textContent = gameState.company.founded.toLocaleDateString();
            document.getElementById("company-reputation").textContent = gameState.company.reputation.toFixed(1);
            document.getElementById("company-reputation-display").textContent = gameState.company.reputation.toFixed(1);
            document.getElementById("company-quota").textContent = gameState.company.quota;
            document.getElementById("current-quota").textContent = gameState.company.quota;
            document.getElementById("quota-upgrade-cost").textContent = formatCurrency(gameState.company.quotaUpgradeCost);
            document.getElementById("total-revenue").textContent = formatCurrency(gameState.company.totalRevenue);
            document.getElementById("total-expenses").textContent = formatCurrency(gameState.company.teacherPayments + gameState.company.operatingExpenses);
            document.getElementById("net-profit").textContent = formatCurrency(gameState.company.netProfit);
            document.getElementById("company-start-date").textContent = gameState.company.founded.toLocaleDateString();
            
            // Update reputation stars display
            updateReputationStars(gameState.company.reputation);
            
            // Update reputation progress bar
            const reputationPercent = (gameState.company.reputation / 5) * 100;
            document.getElementById("reputation-progress-bar").style.width = `${reputationPercent}%`;
            
            // Update weekly financial summary
            document.getElementById("weekly-revenue").textContent = formatCurrency(gameState.company.weeklyStats.revenue);
            document.getElementById("weekly-expenses").textContent = formatCurrency(gameState.company.weeklyStats.expenses);
            document.getElementById("weekly-profit").textContent = formatCurrency(gameState.company.weeklyStats.profit);
            
            // Update expense breakdown
            document.getElementById("rent-expense").textContent = formatCurrency(gameState.company.expenses.rent);
            document.getElementById("utilities-expense").textContent = formatCurrency(gameState.company.expenses.utilities);
            document.getElementById("insurance-expense").textContent = formatCurrency(gameState.company.expenses.insurance);
            document.getElementById("advertising-expense").textContent = formatCurrency(gameState.company.expenses.advertising);
            document.getElementById("admin-expense").textContent = formatCurrency(gameState.company.expenses.adminStaff);
            
            // Update progress bars
            const maxWeeklyRevenue = 10000; // Reference point for progress bars
            document.getElementById("revenue-bar").style.width = `${Math.min(100, (gameState.company.weeklyStats.revenue / maxWeeklyRevenue) * 100)}%`;
            document.getElementById("expenses-bar").style.width = `${Math.min(100, (gameState.company.weeklyStats.expenses / maxWeeklyRevenue) * 100)}%`;
            document.getElementById("profit-bar").style.width = `${Math.min(100, (Math.max(0, gameState.company.weeklyStats.profit) / maxWeeklyRevenue) * 100)}%`;
            
            // Financial summary progress bars
            const totalMoney = gameState.company.totalRevenue;
            document.getElementById("revenue-bar-total").style.width = `${Math.min(100, (totalMoney / 10000) * 10)}%`;
            document.getElementById("expenses-bar-total").style.width = `${Math.min(100, ((gameState.company.teacherPayments + gameState.company.operatingExpenses) / 10000) * 10)}%`;
            document.getElementById("profit-bar-total").style.width = `${Math.min(100, (gameState.company.netProfit / 5000) * 10)}%`;
            
            // Update sessions quota
            document.getElementById("sessions-completed").textContent = gameState.company.sessionsCompleted;
            document.getElementById("sessions-quota").textContent = gameState.company.quota;
            
            const quotaProgress = (gameState.company.sessionsCompleted / gameState.company.quota) * 100;
            document.getElementById("quota-progress-bar").style.width = `${Math.min(100, quotaProgress)}%`;
            
            // Update seek investment button state
            const seekInvestmentBtn = document.getElementById("seek-investment-btn");
            if (gameState.company.reputation >= 4.0) {
                seekInvestmentBtn.classList.remove("opacity-50", "cursor-not-allowed");
                seekInvestmentBtn.removeAttribute("disabled");
            } else {
                seekInvestmentBtn.classList.add("opacity-50", "cursor-not-allowed");
                seekInvestmentBtn.setAttribute("disabled", "true");
            }
            
            // Update quota upgrade button to show current cost
            document.getElementById("upgrade-quota-btn").textContent = `Upgrade Quota ($${formatCurrency(gameState.company.quotaUpgradeCost)})`;
        }

        function updateReputationStars(reputation) {
            const starsContainer = document.getElementById("reputation-stars");
            let starsHTML = '';
            
            const fullStars = Math.floor(reputation);
            const hasHalfStar = reputation - fullStars >= 0.25 && reputation - fullStars < 0.75;
            const hasEmptyStar = reputation - fullStars < 0.25 || fullStars < 5;
            
            // Add full stars
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star"></i>';
            }
            
            // Add half star if needed
            if (hasHalfStar && fullStars < 5) {
                starsHTML += '<i class="fas fa-star-half-alt"></i>';
            }
            
            // Add empty stars
            const emptyStars = hasHalfStar ? 4 - fullStars : 5 - fullStars;
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star"></i>';
            }
            
            starsContainer.innerHTML = starsHTML;
        }

        function updateDashboardStats() {
            document.getElementById("daily-earnings").textContent = formatCurrency(gameState.stats.dailyEarnings);
            
            // Update active value and on-time rate
            document.getElementById("on-time").textContent = gameState.stats.onTimeRate;
            document.getElementById("total-hours").textContent = gameState.stats.totalHours;
            
            let activeValue = 0;
            gameState.activeSessions.forEach(session => {
                // Calculate company's share using the payment model
                const tuition = session.student.tuition;
                const baseHourlyRate = 30;
                const hours = session.student.hours;
                const teacherPayment = (baseHourlyRate * hours) + (tuition * 0.3);
                const companyPayment = tuition - teacherPayment;
                
                activeValue += companyPayment;
            });
            
            document.getElementById("active-value").textContent = formatCurrency(activeValue);
            
            // Update marketing analytics if available
            document.getElementById("student-acquisition").textContent = gameState.stats.studentAcquisition;
            document.getElementById("retention-rate").textContent = gameState.stats.retentionRate;
            document.getElementById("campaign-spend").textContent = formatCurrency(gameState.marketing.totalSpend || 0);
            
            // Calculate overall marketing ROI
            const totalRevenue = gameState.marketing.totalRevenue || 0;
            const totalSpend = gameState.marketing.totalSpend || 0;
            let roi = 0;
            if (totalSpend > 0) {
                roi = ((totalRevenue - totalSpend) / totalSpend) * 100;
            }
            
            document.getElementById("marketing-roi").textContent = Math.round(roi);
            
            // Update earnings chart if canvas exists
            if (document.getElementById('earnings-chart')) {
                updateEarningsChart();
            }
        }

        function updateEarningsChart() {
            const ctx = document.getElementById('earnings-chart').getContext('2d');
            
            // Clear any existing chart
            if (window.earningsChart) {
                window.earningsChart.destroy();
            }
            
            const period = document.getElementById('earnings-period').value;
            let labels, data;
            
            if (period === 'week') {
                labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                data = gameState.stats.weeklyEarnings;
            } else {
                labels = Array.from({ length: 30 }, (_, i) => i + 1);
                data = gameState.stats.monthlyEarnings;
            }
            
            window.earningsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Earnings',
                        data: data,
                        backgroundColor: 'rgba(93, 92, 222, 0.2)',
                        borderColor: 'rgba(93, 92, 222, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

function processCompletedSessions() {
    const now = new Date();
    const completedSessions = gameState.activeSessions.filter(session => session.adjustedEnd <= now);

    completedSessions.forEach(session => {
        const student = session.student;
        const teacher = gameState.teachers.find(t => t.id === session.teacherId);

        // Calculate earnings
        const earnings = student.tuition;
        gameState.company.capital += earnings;
        gameState.stats.dailyEarnings += earnings;
        gameState.stats.weeklyRevenue += earnings;
        gameState.stats.totalRevenue += earnings;
        gameState.stats.sessionsCompleted += 1;

        // Update teacher status
        teacher.active = false;
        teacher.available = true;
        teacher.sessionsCompleted += 1;
        const fatigueIncrease = Math.random() * 10 + 10; // 10-20%
        teacher.fatigue = Math.min(100, teacher.fatigue + fatigueIncrease);

        // Determine if session was on time
        const wasOnTime = session.adjustedEnd <= student.deadline;
        const reputationChange = wasOnTime ? 0.1 : -0.2;
        gameState.company.reputation = Math.min(5, Math.max(0, gameState.company.reputation + reputationChange));

        // Generate student review (99% chance)
        let review = null;
        if (Math.random() < 0.99) {
            const rating = wasOnTime ? Math.floor(Math.random() * 2) + 4 : Math.floor(Math.random() * 3) + 1; // 4-5 if on time, 1-3 if late
            review = {
                studentName: student.nickname || student.name,
                subject: student.subject.name,
                rating: rating,
                comment: wasOnTime ? getPositiveReviewComment() : getNegativeReviewComment(),
                date: new Date()
            };
            gameState.studentReviews.push(review);
        }

        // Show completion modal
        showSessionCompleteModal({
            studentName: student.nickname || student.name,
            subject: student.subject.name,
            teacherName: teacher.name,
            earnings: earnings,
            wasOnTime: wasOnTime,
            deadline: student.deadline,
            completedAt: session.adjustedEnd,
            fatigueIncrease: fatigueIncrease,
            review: review
        });
    });

    // Remove completed sessions
    gameState.activeSessions = gameState.activeSessions.filter(session => session.adjustedEnd > now);

    // Update UI
    if (completedSessions.length > 0) {
        updateCompanyInfo();
        updateDashboardStats();
        updateTeachersCount();
        updateActiveSessionsCount();
        renderActiveSessionsList();
        renderActiveTeachersList();
        renderTeachersList();
        renderStudentReviews();
    }

    return completedSessions.length;
}

// Helper functions for review comments
function getPositiveReviewComment() {
    const comments = [
        "Great session! Very helpful.",
        "The teacher was amazing!",
        "Really improved my understanding.",
        "Worth every penny!"
    ];
    return comments[Math.floor(Math.random() * comments.length)];
}

function getNegativeReviewComment() {
    const comments = [
        "Session was too rushed.",
        "Teacher seemed unprepared.",
        "Not what I expected.",
        "Could be better organized."
    ];
    return comments[Math.floor(Math.random() * comments.length)];
}

function showSessionCompleteModal(details) {
    const modal = document.getElementById("session-complete-modal");
    const detailsElement = document.getElementById("session-complete-details");

    // Generate star rating HTML
    const generateStars = (rating) => {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="fas fa-star text-yellow-500"></i>';
            } else if (i - 0.5 <= rating) {
                stars += '<i class="fas fa-star-half-alt text-yellow-500"></i>';
            } else {
                stars += '<i class="far fa-star text-yellow-500"></i>';
            }
        }
        return stars;
    };

    // Populate modal content
    detailsElement.innerHTML = `
        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-medium">${details.studentName} - ${details.subject}</h4>
                <span class="${details.wasOnTime ? 'text-green-500' : 'text-red-500'} text-sm">
                    ${details.wasOnTime ? 'On Time' : 'Late'}
                </span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p><span class="text-gray-500 dark:text-gray-400">Teacher:</span> ${details.teacherName}</p>
                    <p><span class="text-gray-500 dark:text-gray-400">Completed:</span> ${details.completedAt.toLocaleString()}</p>
                    <p><span class="text-gray-500 dark:text-gray-400">Deadline:</span> ${details.deadline.toLocaleString()}</p>
                </div>
                <div>
                    <p><span class="text-gray-500 dark:text-gray-400">Payment Received:</span> <span class="font-bold text-success">$${formatCurrency(details.earnings)}</span></p>
                    <p><span class="text-gray-500 dark:text-gray-400">Teacher Fatigue:</span> +${details.fatigueIncrease.toFixed(1)}%</p>
                </div>
            </div>
        </div>
        ${details.review ? `
            <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                <h4 class="font-medium mb-2">Student Review</h4>
                <div class="flex items-center mb-2">
                    ${generateStars(details.review.rating)}
                    <span class="ml-2 text-sm">${details.review.rating}/5</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">"${details.review.comment}"</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">— ${details.review.studentName}, ${details.review.date.toLocaleDateString()}</p>
            </div>
        ` : `
            <div class="text-gray-500 dark:text-gray-400 text-center py-2">
                No review provided for this session
            </div>
        `}
    `;

    // Show modal
    modal.classList.remove("hidden");

    // Add close event listeners
    document.getElementById("close-session-complete-modal").onclick = () => modal.classList.add("hidden");
    document.getElementById("session-complete-ok").onclick = () => modal.classList.add("hidden");
}

        function updateTeachersCount() {
            const totalTeachers = gameState.teachers.length;
            const availableTeachers = gameState.teachers.filter(teacher => teacher.available).length;
            
            document.getElementById("teachers-count").textContent = totalTeachers;
            document.getElementById("total-teachers").textContent = totalTeachers;
            document.getElementById("teacher-capacity").textContent = gameState.company.teacherCapacity;
            document.getElementById("available-teachers").textContent = availableTeachers;
            document.getElementById("teachers-change").innerHTML = `<i class="fas fa-arrow-up"></i> ${gameState.applicants.length}`;
            
            // Calculate average skill and salary
            if (totalTeachers > 0) {
                let totalSkill = 0;
                let totalSalary = 0;
                
                gameState.teachers.forEach(teacher => {
                    const avgTeacherSkill = (
                        teacher.skills.onlineTeaching + 
                        teacher.skills.groupTeaching + 
                        teacher.skills.specialNeeds + 
                        teacher.skills.teachingEfficiency
                    ) / 4;
                    
                    totalSkill += avgTeacherSkill;
                    totalSalary += teacher.salary;
                });
                
                const avgSkill = totalSkill / totalTeachers;
                const avgSalary = totalSalary / totalTeachers;
                
                document.getElementById("avg-skill").textContent = avgSkill.toFixed(1);
                document.getElementById("avg-salary").textContent = formatCurrency(avgSalary);
            }
            
            // Render active teachers list
            renderActiveTeachersList();
        }

        function updateStudentsCount() {
    const now = new Date();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6; // 0 = Sunday, 6 = Saturday

    // Filter students based on current day
    const visibleStudents = gameState.availableStudents.filter(student => 
        isWeekend ? true : !student.isWeekendSession // Show all on weekends, only non-weekend on weekdays
    );

    const studentsCountElement = document.getElementById("students-count");
    studentsCountElement.textContent = visibleStudents.length;
}

        function updateActiveSessionsCount() {
            document.getElementById("active-count").textContent = gameState.activeSessions.length;
        }

        function updateNotificationIndicator() {
            const notificationDot = document.getElementById("notification-dot");
            if (gameState.notifications.length > 0) {
                notificationDot.classList.remove("hidden");
            } else {
                notificationDot.classList.add("hidden");
            }
        }

        function updateUpgradesInfo() {
            // Teacher Lounge Info
            document.getElementById("lounge-level").textContent = gameState.company.teacherLoungeLevel;
            document.getElementById("lounge-effect").textContent = gameState.company.teacherLoungeEffect;
            
            // If at max level, hide the upgrade container
            if (gameState.company.teacherLoungeLevel >= 5) {
                document.getElementById("lounge-upgrade-container").innerHTML = `
                    <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <p>Maximum level reached</p>
                    </div>
                `;
            } else {
                document.getElementById("next-lounge-level").textContent = gameState.company.teacherLoungeLevel + 1;
                document.getElementById("next-lounge-effect").textContent = gameState.company.teacherLoungeEffect + 5;
                document.getElementById("lounge-cost").textContent = formatCurrency(gameState.company.teacherLoungeCost);
            }
            
            // Office Expansion Info
            document.getElementById("total-capacity").textContent = gameState.company.teacherCapacity;
            document.getElementById("office-upgrades").textContent = (gameState.company.teacherCapacity - 5) / 2;
            document.getElementById("office-upgrade-cost").textContent = formatCurrency(gameState.company.officeUpgradeCost);
            
            // Workshop Status
            const currentDay = gameState.time.day;
            const workshopAvailable = gameState.marketing.lastWorkshopDay !== currentDay;
            document.getElementById("workshop-status").textContent = workshopAvailable ? "Available today" : "Already used today";
            document.getElementById("host-workshop-btn").disabled = !workshopAvailable;
            document.getElementById("host-workshop-btn").classList.toggle("opacity-50", !workshopAvailable);
            document.getElementById("host-workshop-btn").classList.toggle("cursor-not-allowed", !workshopAvailable);
        }

        function updateMarketingContent() {
            // Show/hide marketing locked section based on unlocked status
            const isUnlocked = gameState.marketing.unlocked;
            document.getElementById("marketing-locked").classList.toggle("hidden", isUnlocked);
            document.getElementById("marketing-campaigns").classList.toggle("hidden", !isUnlocked);
            
            // Update active campaign section if there is one
            const activeCampaign = gameState.marketing.activeCampaign;
            const activeCampaignSection = document.getElementById("active-campaign");
            
            if (activeCampaign) {
                activeCampaignSection.classList.remove("hidden");
                
                // Disable all campaign buttons
                document.querySelectorAll(".start-campaign-btn").forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add("opacity-50", "cursor-not-allowed");
                });
                
                // Update campaign details
                document.getElementById("campaign-name").textContent = activeCampaign.name;
                document.getElementById("campaign-description").textContent = activeCampaign.description;
                document.getElementById("campaign-start").textContent = activeCampaign.startDate.toLocaleDateString();
                document.getElementById("campaign-end").textContent = activeCampaign.endDate.toLocaleDateString();
                document.getElementById("campaign-cost").textContent = `$${formatCurrency(activeCampaign.cost)}`;
                document.getElementById("campaign-students").textContent = gameState.marketing.studentsGained;
                
                // Calculate progress
                const now = new Date();
                const totalDuration = activeCampaign.endDate - activeCampaign.startDate;
                const elapsed = now - activeCampaign.startDate;
                const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                
                document.getElementById("campaign-progress").textContent = `${Math.round(progress)}%`;
                document.getElementById("campaign-progress-bar").style.width = `${progress}%`;
            } else {
                activeCampaignSection.classList.add("hidden");
                
                // Enable campaign buttons
                document.querySelectorAll(".start-campaign-btn").forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                });
            }
            
            // Update campaign history table
            const campaignHistoryTable = document.getElementById("campaign-history");
            if (gameState.marketing.campaignHistory && gameState.marketing.campaignHistory.length > 0) {
                // Clear existing content
                campaignHistoryTable.innerHTML = "";
                
                // Add campaign history rows
                gameState.marketing.campaignHistory.forEach(campaign => {
                    const row = document.createElement("tr");
                    
                    const formattedDate = campaign.startDate.toLocaleDateString();
                    const roiClass = campaign.roi >= 0 ? "text-green-500" : "text-red-500";
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm">${campaign.name}</td>
                        <td class="px-4 py-3 text-sm">$${formatCurrency(campaign.cost)}</td>
                        <td class="px-4 py-3 text-sm">${campaign.studentsGained}</td>
                        <td class="px-4 py-3 text-sm">$${formatCurrency(campaign.revenue)}</td>
                        <td class="px-4 py-3 text-sm ${roiClass}">${campaign.roi}%</td>
                    `;
                    
                    campaignHistoryTable.appendChild(row);
                });
            } else {
                campaignHistoryTable.innerHTML = `
                    <tr>
                        <td class="px-4 py-3 text-sm text-center" colspan="6">No campaign history yet</td>
                    </tr>
                `;
            }
        }

        // Rendering functions
function renderStudentsList() {
    const studentsListElement = document.getElementById("students-list");
    const searchTerm = document.getElementById("students-search")?.value.toLowerCase() || "";
    const filterValue = document.getElementById("students-filter")?.value || "all";
    const sortValue = document.getElementById("students-sort")?.value || "deadline";
    const now = new Date();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6; // 0 = Sunday, 6 = Saturday

    // Filter students
    let filteredStudents = gameState.availableStudents.filter(student => {
        const studentName = (student.nickname || student.name).toLowerCase();
        const matchesSearch =
            studentName.includes(searchTerm) ||
            student.location.name.toLowerCase().includes(searchTerm) ||
            student.subject.name.toLowerCase().includes(searchTerm) ||
            student.school.toLowerCase().includes(searchTerm);

        if (!matchesSearch) return false;

        // Only show weekend students on weekends
        if (student.isWeekendSession && !isWeekend) return false;

        // Apply filters
        switch (filterValue) {
            case "priority": return student.isPriority;
            case "weekend": return student.isWeekendSession;
            case "special": return student.isSpecialNeeds;
            case "returning": return student.visits > 0; // Use visits instead of isReturning
            case "all": default: return true;
        }
    });

    // Sort students
    filteredStudents.sort((a, b) => {
        switch (sortValue) {
            case "payment": return b.tuition - a.tuition;
            case "duration": return b.hours - a.hours;
            case "visits": return (b.visits || 0) - (a.visits || 0);
            case "deadline": default: return a.deadline - b.deadline;
        }
    });

    // Clear the students list
    studentsListElement.innerHTML = "";

    if (filteredStudents.length === 0) {
        studentsListElement.innerHTML = `
            <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                <i class="fas fa-user-graduate text-5xl mb-3 opacity-30"></i>
                <p>No students available at the moment</p>
                <p class="text-sm mt-1">Check back later or adjust your filters</p>
            </div>
        `;
        return;
    }

    // Render each student card
    filteredStudents.forEach(student => {
        const hoursToDeadline = (student.deadline - now) / (1000 * 60 * 60);
        let deadlineClass = "text-success";
        if (hoursToDeadline < 6) deadlineClass = "text-red-500";
        else if (hoursToDeadline < 12) deadlineClass = "text-yellow-500";

        const displayName = student.nickname ? `${student.nickname} (${student.name})` : student.name;
        const returningBadge = student.visits > 0
            ? `<span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full ml-1">Returning x${student.visits}</span>`
            : "";

        const studentCard = document.createElement("div");
        studentCard.className = "bg-gray-100 dark:bg-dark-700 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow";
        studentCard.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="font-semibold">${student.subject.name} Tutoring</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">${student.school}</p>
                </div>
                <div class="flex space-x-1">
                    ${student.isPriority ? `<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">Priority</span>` : ""}
                    ${student.isWeekendSession ? `<span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">Weekend</span>` : ""}
                    ${student.isSpecialNeeds ? `<span class="bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full">Special Needs</span>` : ""}
                </div>
            </div>
            <div class="mb-3 text-sm">
                <div class="flex items-center mb-1">
                    <i class="fas fa-user text-primary w-5"></i>
                    <span class="flex items-center">${displayName} ${returningBadge}</span>
                    <button class="set-nickname-btn ml-2 text-xs text-primary hover:text-secondary" data-student-id="${student.id}" data-student-name="${student.name}">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="flex items-center mb-1">
                    <i class="fas fa-map-marker-alt text-red-500 w-5"></i>
                    <span>${student.location.name}</span>
                </div>
                <div class="flex items-center mb-1">
                    <i class="fas fa-book text-yellow-500 w-5"></i>
                    <span>${student.subject.name} (${student.subject.category})</span>
                </div>
                <div class="flex items-center mb-1">
                    <i class="fas fa-hourglass-half text-blue-500 w-5"></i>
                    <span>${student.hours} hours ($${student.subject.baseRate}/hr base rate)</span>
                </div>
                <div class="flex items-center ${deadlineClass}">
                    <i class="fas fa-clock w-5"></i>
                    <span>${student.deadline.toLocaleString()}</span>
                </div>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-dark-600">
                <div class="text-xl font-bold">$${formatCurrency(student.tuition)}</div>
                <button class="assign-student-btn bg-primary hover:bg-secondary text-white px-3 py-1.5 rounded-lg text-sm" data-student-id="${student.id}">
                    Assign Teacher
                </button>
            </div>
        `;

        studentsListElement.appendChild(studentCard);
    });

    // Add event listeners for assign buttons
    document.querySelectorAll(".assign-student-btn").forEach(button => {
        button.addEventListener("click", (e) => {
            const studentId = parseInt(e.target.getAttribute("data-student-id"));
            showAssignmentModal(studentId);
        });
    });

    // Add event listeners for nickname buttons
    document.querySelectorAll(".set-nickname-btn").forEach(button => {
        button.addEventListener("click", (e) => {
            e.stopPropagation();
            const studentId = parseInt(button.getAttribute("data-student-id"));
            const studentName = button.getAttribute("data-student-name");
            showStudentNicknameModal(studentId, studentName);
        });
    });
}

// Helper function to check if it's a weekend (assumed to exist elsewhere, included here for clarity)
function isWeekend() {
    const now = new Date();
    return now.getDay() === 0 || now.getDay() === 6; // Sunday or Saturday
}

        function renderStudentReviews() {
            const reviewsListElement = document.getElementById("student-reviews-list");
            
            // Clear the reviews list
            reviewsListElement.innerHTML = '';
            
            if (gameState.studentReviews.length === 0) {
                reviewsListElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-star text-5xl mb-3 opacity-30"></i>
                        <p>No student reviews yet</p>
                        <p class="text-sm mt-1">Complete sessions to receive reviews</p>
                    </div>
                `;
                return;
            }
            
            // Render each review
            gameState.studentReviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'bg-gray-100 dark:bg-dark-700 rounded-lg p-4';
                
                let starsHTML = '';
                for (let i = 0; i < 5; i++) {
                    if (i < review.rating) {
                        starsHTML += '<i class="fas fa-star text-yellow-500"></i>';
                    } else {
                        starsHTML += '<i class="far fa-star text-yellow-500"></i>';
                    }
                }
                
                reviewCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-medium">${review.studentName}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${review.subject} with ${review.teacherName}</div>
                        </div>
                        <div class="star-rating">
                            ${starsHTML}
                        </div>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300">"${review.comment}"</p>
                    <div class="text-right text-xs text-gray-500 dark:text-gray-400 mt-2">
                        ${formatDateAgo(review.date)}
                    </div>
                `;
                
                reviewsListElement.appendChild(reviewCard);
            });
        }

        function renderTeachersList() {
            const teachersListElement = document.getElementById("teachers-list");
            const searchTerm = document.getElementById("teachers-search").value.toLowerCase();
            const filterValue = document.getElementById("teachers-filter").value;
            const sortValue = document.getElementById("teachers-sort").value;
            
            // Filter teachers
            let filteredTeachers = gameState.teachers.filter(teacher => {
                const matchesSearch = teacher.name.toLowerCase().includes(searchTerm) || 
                                     teacher.specialization.area.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                if (filterValue === 'available' && !teacher.available) return false;
                if (filterValue === 'off-duty' && teacher.available) return false;
                if (filterValue === 'high-skill') {
                    const avgSkill = (
                        teacher.skills.onlineTeaching + 
                        teacher.skills.groupTeaching + 
                        teacher.skills.specialNeeds + 
                        teacher.skills.teachingEfficiency
                    ) / 4;
                    if (avgSkill < 7) return false;
                }
                if (filterValue === 'low-loyalty' && teacher.loyalty >= 50) return false;
                
                return true;
            });
            
            // Sort teachers
            if (sortValue === 'loyalty') {
                filteredTeachers.sort((a, b) => b.loyalty - a.loyalty);
            } else if (sortValue === 'salary') {
                filteredTeachers.sort((a, b) => b.salary - a.salary);
            } else if (sortValue === 'skill') {
                filteredTeachers.sort((a, b) => {
                    const avgSkillA = (
                        a.skills.onlineTeaching + 
                        a.skills.groupTeaching + 
                        a.skills.specialNeeds + 
                        a.skills.teachingEfficiency
                    ) / 4;
                    
                    const avgSkillB = (
                        b.skills.onlineTeaching + 
                        b.skills.groupTeaching + 
                        b.skills.specialNeeds + 
                        b.skills.teachingEfficiency
                    ) / 4;
                    
                    return avgSkillB - avgSkillA;
                });
            } else if (sortValue === 'sessions') {
                filteredTeachers.sort((a, b) => b.sessionsCompleted - a.sessionsCompleted);
            }
            
            // Clear the teachers list
            teachersListElement.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                teachersListElement.innerHTML = `
                    <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-chalkboard-teacher text-5xl mb-3 opacity-30"></i>
                        <p>No teachers found</p>
                        <p class="text-sm mt-1">Adjust your search or hire more teachers</p>
                    </div>
                `;
                return;
            }
            
            // Render each teacher card
            filteredTeachers.forEach(teacher => {
                const avgSkill = (
                    teacher.skills.onlineTeaching + 
                    teacher.skills.groupTeaching + 
                    teacher.skills.specialNeeds + 
                    teacher.skills.teachingEfficiency
                ) / 4;
                
                let statusClass, statusText;
                if (teacher.active) {
                    statusClass = 'bg-blue-500';
                    statusText = 'In Session';
                } else if (teacher.available) {
                    statusClass = 'bg-green-500';
                    statusText = 'Available';
                } else {
                    statusClass = 'bg-gray-500';
                    statusText = 'Off Duty';
                }
                
                let loyaltyClass = 'text-green-500';
                if (teacher.loyalty < 50) {
                    loyaltyClass = 'text-red-500';
                } else if (teacher.loyalty < 80) {
                    loyaltyClass = 'text-yellow-500';
                }
                
                let fatigueClass = 'text-green-500';
                if (teacher.fatigue > 75) {
                    fatigueClass = 'text-red-500';
                } else if (teacher.fatigue > 50) {
                    fatigueClass = 'text-yellow-500';
                }
                
                // Show subject specialty
                const teacherSubjects = subjectCategories[teacher.specialization.area] || [];
                const subjectsList = teacherSubjects.length > 0 
                    ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Teaches: ${teacherSubjects.join(', ')}</p>`
                    : '';
                
                // Add warning indicators for risk/disengaged
                let warningIndicators = '';
                if (teacher.risk) {
                    warningIndicators += `<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">Risk of Quitting</span>`;
                }
                if (teacher.disengaged) {
                    warningIndicators += `<span class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">Disengaged</span>`;
                }
                
                const teacherCard = document.createElement('div');
                teacherCard.className = `bg-gray-100 dark:bg-dark-700 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow ${teacher.risk ? 'shake-animation' : ''}`;
                teacherCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg flex items-center">
                                ${teacher.name}
                                ${warningIndicators}
                            </h3>
                            <div class="flex items-center">
                                <span class="${statusClass} text-white text-xs px-2 py-0.5 rounded-full">${statusText}</span>
                                <span class="text-gray-500 dark:text-gray-400 text-xs ml-2">
                                    ${formatDateAgo(teacher.hireDate)}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="view-teacher-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-teacher-id="${teacher.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="rename-teacher-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-teacher-id="${teacher.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="adjust-salary-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-teacher-id="${teacher.id}">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Online Teaching</div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.onlineTeaching * 10}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Group Teaching</div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.groupTeaching * 10}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Special Needs</div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.specialNeeds * 10}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Teaching Efficiency</div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.teachingEfficiency * 10}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-dark-800 p-3 rounded-lg">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-book text-primary mr-2"></i>
                            <span>${teacher.specialization.area} Specialist</span>
                        </div>
                        ${subjectsList}
                        <div class="flex text-sm text-gray-500 dark:text-gray-400 space-x-4 mt-1">
                            <span>Pace: ${teacher.specialization.pace.toFixed(1)}</span>
                            <span>Efficiency: ${teacher.specialization.efficiency}/5</span>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-2 gap-2 border-t border-gray-200 dark:border-dark-600 pt-3">
                        <div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500 dark:text-gray-400">Fatigue</span>
                                <span class="text-sm ${fatigueClass}">${teacher.fatigue}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2 mt-1">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${teacher.fatigue}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500 dark:text-gray-400">Loyalty</span>
                                <span class="text-sm ${loyaltyClass}">${teacher.loyalty}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2 mt-1">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${teacher.loyalty}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <div>
                            <span class="font-semibold">$${formatCurrency(teacher.salary)}</span>
                            <span class="text-xs text-gray-500">/week base + 30% commission</span>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <span class="text-xs bg-gray-200 dark:bg-dark-600 rounded px-2 py-0.5">
                                ${teacher.sessionsCompleted} sessions
                            </span>
                            <span class="ml-2">
                                ${teacher.workingHours.start} - ${teacher.workingHours.end}
                            </span>
                        </div>
                    </div>
                `;
                
                teachersListElement.appendChild(teacherCard);
            });
            
            // Add event listeners for teacher cards
            document.querySelectorAll('.view-teacher-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const teacherId = parseInt(e.target.closest('.view-teacher-btn').getAttribute('data-teacher-id'));
                    showTeacherDetailModal(teacherId);
                });
            });
            
            document.querySelectorAll('.rename-teacher-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const teacherId = parseInt(e.target.closest('.rename-teacher-btn').getAttribute('data-teacher-id'));
                    showRenameTeacherModal(teacherId);
                });
            });
            
            document.querySelectorAll('.adjust-salary-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const teacherId = parseInt(e.target.closest('.adjust-salary-btn').getAttribute('data-teacher-id'));
                    showAdjustSalaryModal(teacherId);
                });
            });
        }

        function renderApplicantsList() {
            const applicantsListElement = document.getElementById("applicants-list");
            
            // Clear the applicants list
            applicantsListElement.innerHTML = '';
            
            if (gameState.applicants.length === 0) {
                applicantsListElement.innerHTML = `
                    <div class="col-span-full text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-user-plus text-5xl mb-3 opacity-30"></i>
                        <p>No teacher applications at the moment</p>
                        <p class="text-sm mt-1">Check back later or refresh the list</p>
                    </div>
                `;
                return;
            }
            
            // Render each applicant card
            gameState.applicants.forEach(applicant => {
                const avgSkill = (
                    applicant.skills.onlineTeaching + 
                    applicant.skills.groupTeaching + 
                    applicant.skills.specialNeeds + 
                    applicant.skills.teachingEfficiency
                ) / 4;
                
                // Show subject specialty
                const teacherSubjects = subjectCategories[applicant.specialization.area] || [];
                const subjectsList = teacherSubjects.length > 0 
                    ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Teaches: ${teacherSubjects.join(', ')}</p>`
                    : '';
                
                const applicantCard = document.createElement('div');
                applicantCard.className = 'bg-gray-100 dark:bg-dark-700 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow';
                applicantCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg">${applicant.name}</h3>
                            <div class="text-gray-500 dark:text-gray-400 text-sm">Teacher Applicant</div>
                        </div>
                        <div class="bg-yellow-500 bg-opacity-10 text-yellow-500 p-1 rounded">
                            <i class="fas fa-star mr-1"></i>${avgSkill.toFixed(1)}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Online: ${applicant.skills.onlineTeaching}/10</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Group: ${applicant.skills.groupTeaching}/10</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Special: ${applicant.skills.specialNeeds}/10</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Efficiency: ${applicant.skills.teachingEfficiency}/10</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-dark-800 p-3 rounded-lg mb-3">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-book text-primary mr-2"></i>
                            <span>${applicant.specialization.area} Specialist</span>
                        </div>
                        ${subjectsList}
                        <div class="flex text-sm text-gray-500 dark:text-gray-400 space-x-4 mt-1">
                            <span>Pace: ${applicant.specialization.pace.toFixed(1)}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="text-sm text-gray-500 dark:text-gray-400">Working Hours</div>
                        <div>${applicant.workingHours.start} - ${applicant.workingHours.end} (${applicant.workingHours.duration}h)</div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-dark-600">
                        <div>
                            <span class="text-lg font-bold">$${formatCurrency(applicant.salary)}</span>
                            <span class="text-xs text-gray-500">/week + 30% commission</span>
                        </div>
                        <button class="hire-teacher-btn bg-primary hover:bg-secondary text-white px-3 py-1.5 rounded-lg text-sm" data-applicant-id="${applicant.id}">
                            Hire Teacher
                        </button>
                    </div>
                `;
                
                applicantsListElement.appendChild(applicantCard);
            });
            
            // Add event listeners for hire buttons
            document.querySelectorAll('.hire-teacher-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const applicantId = parseInt(e.target.getAttribute('data-applicant-id'));
                    hireTeacher(applicantId);
                });
            });
        }

        function renderActiveTeachersList() {
            const activeTeachersListElement = document.getElementById("active-teachers-list");
            
            // Clear the active teachers list
            activeTeachersListElement.innerHTML = '';
            
            const activeTeachers = gameState.teachers.filter(teacher => teacher.active);
            
            if (activeTeachers.length === 0) {
                activeTeachersListElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-center py-8">
                        No active teachers
                    </div>
                `;
                return;
            }
            
            // Render each active teacher
            activeTeachers.forEach(teacher => {
                const activeSession = gameState.activeSessions.find(s => s.teacher === teacher.id);
                if (!activeSession) return;
                
                const student = activeSession.student;
                // Use nickname if available
                const studentName = student.nickname || student.name;
                
                const teacherItem = document.createElement('div');
                teacherItem.className = 'flex items-center p-3 rounded-lg bg-gray-100 dark:bg-dark-700';
                teacherItem.innerHTML = `
                    <div class="mr-3 bg-primary bg-opacity-10 text-primary p-2 rounded-lg">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <div class="font-medium">${teacher.name}</div>
                            <div class="text-gray-500 dark:text-gray-400 text-sm">${formatProgressTime(activeSession.startTime, activeSession.adjustedEnd)}</div>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center">
                            <div class="truncate">
                                Tutoring ${studentName} in ${student.subject.name}
                            </div>
                            <span class="ml-2 text-xs bg-blue-500 text-white px-1.5 rounded-full">${student.hours} hrs</span>
                        </div>
                    </div>
                `;
                
                activeTeachersListElement.appendChild(teacherItem);
            });
        }

        function renderActiveSessionsList() {
            const activeSessionsListElement = document.getElementById("active-sessions-list");
            
            // Clear the active sessions list
            activeSessionsListElement.innerHTML = '';
            
            if (gameState.activeSessions.length === 0) {
                activeSessionsListElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-center py-16">
                        <i class="fas fa-users-class text-5xl mb-3 opacity-30"></i>
                        <p>No active sessions</p>
                        <p class="text-sm mt-1">Assign teachers to students to get started</p>
                    </div>
                `;
                return;
            }
            
            // Sort by expected end time
            const sortedSessions = [...gameState.activeSessions].sort((a, b) => a.adjustedEnd - b.adjustedEnd);
            
            // Render each active session
            sortedSessions.forEach(session => {
                const student = session.student;
                const teacher = gameState.teachers.find(t => t.id === session.teacher);
                
                if (!teacher) return;
                
                // Use nickname if available
                const studentName = student.nickname || student.name;
                
                const now = new Date();
                const totalDuration = session.adjustedEnd - session.startTime;
                const elapsed = now - session.startTime;
                const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                
                const progressBarColor = student.deadline > session.adjustedEnd ? 'bg-green-500' : 'bg-red-500';
                
                // Show subject match indicator
                let matchIndicator = '';
                if (session.subjectMatchScore > 5) {
                    matchIndicator = `<span class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full ml-1">Perfect Match</span>`;
                } else if (session.subjectMatchScore > 0) {
                    matchIndicator = `<span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full ml-1">Good Match</span>`;
                } else {
                    matchIndicator = `<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-1">Subject Mismatch</span>`;
                }
                
                // Format actual class time remaining vs academic hours
                const actualDuration = (session.adjustedEnd - session.startTime) / (1000 * 60 * 60);
                const academicToActualRatio = student.hours / actualDuration;
                
                const sessionCard = document.createElement('div');
                sessionCard.className = 'bg-gray-100 dark:bg-dark-700 rounded-xl p-4 shadow-sm';
                sessionCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold">${student.subject.name}</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">${student.school}</p>
                        </div>
                        <div class="flex space-x-1">
                            ${student.isPriority ? `<span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">Priority</span>` : ''}
                            ${student.isWeekendSession ? `<span class="bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">Weekend</span>` : ''}
                            ${student.isSpecialNeeds ? `<span class="bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full">Special Needs</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-user-graduate text-primary w-5"></i>
                                <span>Student: ${studentName}</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-map-marker-alt text-red-500 w-5"></i>
                                <span>Location: ${student.location.name}</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-book text-yellow-500 w-5"></i>
                                <span>Subject: ${student.subject.name}</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-chalkboard-teacher text-purple-500 w-5"></i>
                                <span>Teacher: ${teacher.name}</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-graduation-cap text-primary w-5"></i>
                                <span>Specialty: ${teacher.specialization.area} ${matchIndicator}</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <i class="fas fa-hourglass-half text-yellow-500 w-5"></i>
                                <span>Academic hours: ${student.hours} (at pace ${teacher.specialization.pace.toFixed(1)})</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <div>
                                <i class="fas fa-hourglass-start text-gray-500 dark:text-gray-400 mr-1"></i>
                                ${new Date(session.startTime).toLocaleString()}
                            </div>
                            <div>
                                <i class="fas fa-hourglass-end text-gray-500 dark:text-gray-400 mr-1"></i>
                                ${new Date(session.adjustedEnd).toLocaleString()}
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2.5">
                            <div class="session-progress-bar ${progressBarColor} h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <div>${Math.round(progress)}% complete</div>
                            <div>
                                ${formatProgressTime(session.startTime, session.adjustedEnd)}
                                <span class="text-xs text-gray-500 ml-1">(${student.hours}h at pace ${teacher.specialization.pace.toFixed(1)})</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-2 flex justify-between items-center pt-2 border-t border-gray-200 dark:border-dark-600">
                <div>
                    <span class="text-gray-500 dark:text-gray-400 text-sm">Tuition:</span>
                    <span class="text-lg font-bold ml-1">$${formatCurrency(student.tuition)}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Deadline:</span>
                        <span class="${student.deadline > session.adjustedEnd ? 'text-green-500' : 'text-red-500'} ml-1">
                            ${new Date(student.deadline).toLocaleString()}
                        </span>
                    </div>
                    <button class="finalize-session-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm" 
                            data-session-id="${session.id}">
                        Finalize Session
                    </button>
                </div>
            </div>
                `;
                
                activeSessionsListElement.appendChild(sessionCard);
            });

// Add event listeners for finalize buttons
    document.querySelectorAll('.finalize-session-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const sessionId = parseInt(e.target.getAttribute('data-session-id'));
            forceCompleteSession(sessionId);
        });
    });
        }

function forceCompleteSession(sessionId) {
    const sessionIndex = gameState.activeSessions.findIndex(s => s.id === sessionId);
    if (sessionIndex === -1) return;

    const session = gameState.activeSessions[sessionIndex];
    const teacher = gameState.teachers.find(t => t.id === session.teacherId);
    const student = session.student;

    // Simulate session completion
    const completionData = completeSession(session.id, true); // true indicates forced completion
    
    if (completionData) {
        // Show completion popup
        showSessionCompleteModal(completionData);
        
        // Update UI
        updateActiveSessionsCount();
        renderActiveSessionsList();
        renderActiveTeachersList();
        updateDashboardStats();
        updateTeachersList();
    }
}

        function renderNotificationsList() {
            const notificationsListElement = document.getElementById("notifications-list");
            
            // Clear the notifications list
            notificationsListElement.innerHTML = '';
            
            if (gameState.notifications.length === 0) {
                notificationsListElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-center py-8">
                        No notifications
                    </div>
                `;
                return;
            }
            
            // Render each notification
            gameState.notifications.forEach(notification => {
                let iconClass = 'fas fa-info-circle text-blue-500';
                
                if (notification.type === 'success') {
                    iconClass = 'fas fa-check-circle text-green-500';
                } else if (notification.type === 'warning') {
                    iconClass = 'fas fa-exclamation-triangle text-yellow-500';
                } else if (notification.type === 'error') {
                    iconClass = 'fas fa-times-circle text-red-500';
                }
                
                const notificationItem = document.createElement('div');
                notificationItem.className = 'flex p-3 border-b last:border-b-0 border-gray-200 dark:border-dark-600';
                notificationItem.innerHTML = `
                    <div class="mr-3">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-1">
                        <p>${notification.message}</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">${formatTimeAgo(notification.time)}</p>
                    </div>
                `;
                
                notificationsListElement.appendChild(notificationItem);
            });
        }

        // Modal functions
        function showAssignmentModal(studentId) {
            const student = gameState.availableStudents.find(s => s.id === studentId);
            
            if (!student) return;
            
            const modal = document.getElementById("assignment-modal");
            const studentDetailsElement = document.getElementById("assignment-student-details");
            const availableTeachersElement = document.getElementById("assignment-teachers-list");
            const confirmBtn = document.getElementById("confirm-assignment");
            
            // Set student details (with nickname if available)
            const studentName = student.nickname || student.name;
            studentDetailsElement.innerHTML = `
                <h4 class="font-semibold mb-2">${student.school}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-user-graduate text-primary w-5"></i>
                            <span>${studentName}${student.nickname ? ` (${student.name})` : ''}</span>
                        </div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-book text-red-500 w-5"></i>
                            <span>${student.subject.name} (${student.subject.category})</span>
                        </div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-map-marker-alt text-green-500 w-5"></i>
                            <span>Location: ${student.location.name}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-hourglass-half text-blue-500 w-5"></i>
                            <span>Academic hours: ${student.hours}</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-calendar-alt text-yellow-500 w-5"></i>
                            <span>Deadline: ${student.deadline.toLocaleString()}</span>
                        </div>
                        <div class="flex items-center mb-1">
                            <i class="fas fa-tags text-purple-500 w-5"></i>
                            <span>
                                ${student.isPriority ? '<span class="text-red-500 mr-1">Priority</span>' : ''}
                                ${student.isWeekendSession ? '<span class="text-blue-500 mr-1">Weekend</span>' : ''}
                                ${student.isSpecialNeeds ? '<span class="text-yellow-500">Special Needs</span>' : ''}
                            </span>
                        </div>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-dollar-sign text-green-500 w-5"></i>
                            <span class="font-bold">Tuition: $${formatCurrency(student.tuition)}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Base Rate: $${student.subject.baseRate}/hr × ${student.hours}hr
                            ${student.isPriority ? '× 1.25 priority' : ''}
                            ${student.isWeekendSession ? '× 1.35 weekend' : ''}
                            ${student.isSpecialNeeds ? '× 1.2 special needs' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Get available teachers
            const availableTeachers = gameState.teachers.filter(teacher => teacher.available);
            
            // Reset confirm button
            confirmBtn.setAttribute('disabled', 'true');
            confirmBtn.dataset.studentId = student.id;
            confirmBtn.dataset.teacherId = '';
            
            // Set available teachers
            availableTeachersElement.innerHTML = '';
            
            if (availableTeachers.length === 0) {
                availableTeachersElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-center py-8">
                        No available teachers
                    </div>
                `;
            } else {
                // Sort teachers by suitability for this student - revised for strict subject matching
                const suitableTeachers = availableTeachers.map(teacher => {
                    let score = 0;
                    
                    // Check subject match - the most important factor now
                    const teacherArea = teacher.specialization.area;
                    const studentSubject = student.subject.name;
                    const studentCategory = student.subject.category;
                    
                    let subjectMatchScore = 0;
                    let matchDescription = '';
                    let matchClass = '';
                    
                    // Perfect match - teacher's area exactly matches the subject category
                    if (teacherArea === studentCategory) {
                        subjectMatchScore = 25; // Big bonus for perfect match
                        matchDescription = 'Perfect subject match';
                        matchClass = 'text-green-500';
                    } 
                    // Good match - subject belongs to teacher's specialty
                    else if (subjectCategories[teacherArea] && 
                             subjectCategories[teacherArea].includes(studentSubject)) {
                        subjectMatchScore = 15; 
                        matchDescription = 'Good subject match';
                        matchClass = 'text-blue-500';
                    }
                    // Mismatch - teaching outside specialty
                    else {
                        subjectMatchScore = -20; // Major penalty
                        matchDescription = 'Subject mismatch';
                        matchClass = 'text-red-500';
                    }
                    
                    score += subjectMatchScore;
                    
                    // Check skills
                    if (student.isWeekendSession) {
                        score += teacher.skills.onlineTeaching;
                    }
                    
                    if (student.isSpecialNeeds) {
                        score += teacher.skills.specialNeeds;
                    }
                    
                    // Teaching efficiency affects all sessions
                    score += teacher.skills.teachingEfficiency / 2;
                    
                    // Fatigue penalty
                    score -= teacher.fatigue / 10;
                    
                    // Loyalty penalty
                    if (teacher.loyalty < 50) {
                        score -= (50 - teacher.loyalty) / 5; // Up to -10 points for very low loyalty
                    }
                    
                    return {
                        teacher,
                        score,
                        matchDescription,
                        matchClass,
                        subjectMatchScore
                    };
                }).sort((a, b) => b.score - a.score);
                
                suitableTeachers.forEach((item, index) => {
                    const teacher = item.teacher;
                    const estimatedDuration = formatDurationAndTime(student.hours, teacher.specialization.pace);
                    
                    // Calculate expected earnings based on our payment model
                    const baseHourlyRate = 30; // Base hourly rate
                    const commission = student.tuition * 0.3; // 30% commission
                    const expectedEarnings = (baseHourlyRate * student.hours) + commission;
                    
                    // Update compatibility description based on revised matching
                    let compatibility = item.matchDescription;
                    let compatibilityClass = item.matchClass;
                    
                    // Add additional warnings if needed
                    let additionalWarnings = [];
                    
                    if (item.subjectMatchScore >= 0) { // Only check these if subject match is OK
                        if (student.isWeekendSession && teacher.skills.onlineTeaching < 5) {
                            additionalWarnings.push("Low online teaching skill");
                        }
                        if (student.isSpecialNeeds && teacher.skills.specialNeeds < 5) {
                            additionalWarnings.push("Low special needs skill");
                        }
                        if (teacher.fatigue > 50) {
                            additionalWarnings.push("Teacher fatigue warning");
                        }
                        if (teacher.loyalty < 50) {
                            additionalWarnings.push("Teacher disengaged");
                            compatibilityClass = "text-orange-500";
                        }
                    }
                    
                    const warningText = additionalWarnings.length > 0 
                        ? ` • ${additionalWarnings.join(" • ")}` 
                        : '';
                    
                    const teacherItem = document.createElement('div');
                    teacherItem.className = `bg-gray-100 dark:bg-dark-700 rounded-lg p-3 teacher-selection ${index === 0 ? 'ring-2 ring-primary' : ''}`;
                    teacherItem.dataset.teacherId = teacher.id;
                    teacherItem.dataset.subjectMatch = item.subjectMatchScore;
                    teacherItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">${teacher.name}</div>
                                <div class="text-sm ${compatibilityClass}">${compatibility}${warningText}</div>
                            </div>
                            <div class="bg-white dark:bg-dark-800 text-xs px-2 py-1 rounded">
                                Est. time: ${estimatedDuration}
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Online:</span>
                                <span>${teacher.skills.onlineTeaching}/10</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Special:</span>
                                <span>${teacher.skills.specialNeeds}/10</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Area:</span>
                                <span>${teacher.specialization.area}</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Fatigue:</span>
                                <span>${teacher.fatigue}%</span>
</div>
                        </div>
                        <div class="mt-2 flex justify-between items-center">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Estimate:</span>
                                <span class="font-bold">$${formatCurrency(expectedEarnings)}</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 text-xs">
                                ${teacher.workingHours.start} - ${teacher.workingHours.end}
                            </div>
                        </div>
                    `;
                    
                    teacherItem.addEventListener('click', () => {
                        // Remove highlight from all items
                        document.querySelectorAll('.teacher-selection').forEach(el => {
                            el.classList.remove('ring-2', 'ring-primary');
                        });
                        
                        // Add highlight to selected item
                        teacherItem.classList.add('ring-2', 'ring-primary');
                        
                        // Update confirm button
                        confirmBtn.removeAttribute('disabled');
                        confirmBtn.dataset.teacherId = teacher.id;
                        
                        // Add warning if subject mismatch
                        if (item.subjectMatchScore < 0) {
                            showToast("Warning: This teacher isn't specialized in this subject category. Performance will be reduced.", "warning");
                        }
                    });
                    
                    availableTeachersElement.appendChild(teacherItem);
                });
                
                // Default select the first teacher if available
                if (suitableTeachers.length > 0) {
                    confirmBtn.dataset.teacherId = suitableTeachers[0].teacher.id;
                    confirmBtn.removeAttribute('disabled');
                    
                    // Add warning if subject mismatch for first teacher
                    if (suitableTeachers[0].subjectMatchScore < 0) {
                        showToast("Warning: This teacher isn't specialized in this subject category. Performance will be reduced.", "warning");
                    }
                }
            }
            
            // Show modal
            modal.classList.remove("hidden");
        }

        function showTeacherDetailModal(teacherId) {
            const teacher = gameState.teachers.find(t => t.id === teacherId);
            
            if (!teacher) return;
            
            const modal = document.getElementById("teacher-detail-modal");
            const detailContentElement = document.getElementById("teacher-detail-content");
            const terminateBtn = document.getElementById("terminate-teacher-btn");
            
            // Calculate average skill
            const avgSkill = (
                teacher.skills.onlineTeaching + 
                teacher.skills.groupTeaching + 
                teacher.skills.specialNeeds + 
                teacher.skills.teachingEfficiency
            ) / 4;
            
            // Set teacher details
            detailContentElement.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-lg">${teacher.name}</h3>
                        <div class="flex items-center text-gray-500 dark:text-gray-400 text-sm">
                            <span>Hired on ${new Date(teacher.hireDate).toLocaleDateString()}</span>
                            <span class="mx-2">•</span>
                            <span>${teacher.workingHours.start} - ${teacher.workingHours.end}</span>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-medium mb-2">Skills</h4>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Online Teaching</span>
                                        <span>${teacher.skills.onlineTeaching}/10</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.onlineTeaching * 10}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Group Teaching</span>
                                        <span>${teacher.skills.groupTeaching}/10</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.groupTeaching * 10}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Special Needs</span>
                                        <span>${teacher.skills.specialNeeds}/10</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.specialNeeds * 10}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Teaching Efficiency</span>
                                        <span>${teacher.skills.teachingEfficiency}/10</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-primary h-2 rounded-full" style="width: ${teacher.skills.teachingEfficiency * 10}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <div class="bg-primary bg-opacity-10 text-primary px-2 py-1 rounded inline-block">
                                    <i class="fas fa-star mr-1"></i> Overall: ${avgSkill.toFixed(1)}/10
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg mb-4">
                            <h4 class="font-medium mb-2">Specialization</h4>
                            <div class="flex items-center mb-2">
                                <i class="fas fa-book text-primary mr-2"></i>
                                <span class="font-semibold">${teacher.specialization.area}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="text-gray-500 dark:text-gray-400">Pace:</span>
                                    <span>${teacher.specialization.pace.toFixed(1)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500 dark:text-gray-400">Efficiency:</span>
                                    <span>${teacher.specialization.efficiency}/5</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-100 dark:bg-dark-700 p-4 rounded-lg">
                            <h4 class="font-medium mb-2">Status</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Fatigue</span>
                                        <span class="${teacher.fatigue > 75 ? 'text-red-500' : (teacher.fatigue > 50 ? 'text-yellow-500' : 'text-green-500')}">${teacher.fatigue}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${teacher.fatigue}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Loyalty</span>
                                        <span class="${teacher.loyalty < 50 ? 'text-red-500' : (teacher.loyalty < 80 ? 'text-yellow-500' : 'text-green-500')}">${teacher.loyalty}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: ${teacher.loyalty}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>Weekly Salary:</span>
                                    <span class="font-semibold">$${formatCurrency(teacher.salary)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Recovery Rate:</span>
                                    <span>${teacher.fatigueRecoveryRate.toFixed(2)}×</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Status:</span>
                                    <span>${teacher.active ? 'In Session' : (teacher.available ? 'Available' : 'Off Duty')}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Sessions Completed:</span>
                                    <span>${teacher.sessionsCompleted}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    ${teacher.risk ? `
                        <div class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-3 rounded-lg flex items-start">
                            <i class="fas fa-exclamation-triangle mt-1 mr-3"></i>
                            <div>
                                <p class="font-medium">Risk of Quitting</p>
                                <p class="text-sm mt-1">This teacher has very low loyalty and may quit at any moment. Consider raising their salary or addressing any issues.</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${teacher.disengaged && !teacher.risk ? `
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 p-3 rounded-lg flex items-start">
                            <i class="fas fa-exclamation-circle mt-1 mr-3"></i>
                            <div>
                                <p class="font-medium">Teacher is Disengaged</p>
                                <p class="text-sm mt-1">This teacher is demonstrating poor performance due to low loyalty. Consider improving their working conditions.</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Show/hide terminate button based on active state
            if (teacher.active) {
                terminateBtn.classList.add("hidden");
            } else {
                terminateBtn.classList.remove("hidden");
                terminateBtn.dataset.teacherId = teacher.id;
            }
            
            // Show modal
            modal.classList.remove("hidden");
        }

        function showRenameTeacherModal(teacherId) {
            const teacher = gameState.teachers.find(t => t.id === teacherId);
            
            if (!teacher) return;
            
            const modal = document.getElementById("rename-teacher-modal");
            const nameInput = document.getElementById("new-teacher-name");
            const confirmBtn = document.getElementById("confirm-rename");
            
            // Set current name
            nameInput.value = teacher.name;
            
            // Set teacher ID to confirm button
            confirmBtn.dataset.teacherId = teacher.id;
            
            // Show modal
            modal.classList.remove("hidden");
            
            // Focus the input
            setTimeout(() => nameInput.focus(), 100);
        }

        function showAdjustSalaryModal(teacherId) {
            const teacher = gameState.teachers.find(t => t.id === teacherId);
            
            if (!teacher) return;
            
            const modal = document.getElementById("adjust-salary-modal");
            const teacherInfoElement = document.getElementById("current-teacher-info");
            const salaryInput = document.getElementById("new-salary");
            const salaryImpactElement = document.getElementById("salary-impact");
            const confirmBtn = document.getElementById("confirm-salary-adjust");
            
            // Set teacher info
            teacherInfoElement.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="font-medium">${teacher.name}</span>
                    <span>${teacher.specialization.area} Specialist</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <div>
                        <span class="text-gray-500 dark:text-gray-400">Current Salary:</span>
                        <span class="font-semibold">$${formatCurrency(teacher.salary)}/week</span>
                    </div>
                    <div>
                        <span class="text-gray-500 dark:text-gray-400">Loyalty:</span>
                        <span class="${teacher.loyalty < 50 ? 'text-red-500' : (teacher.loyalty < 80 ? 'text-yellow-500' : 'text-green-500')}">${teacher.loyalty}%</span>
                    </div>
                </div>
            `;
            
            // Set current salary
            salaryInput.value = teacher.salary;
            
            // Set teacher ID to confirm button
            confirmBtn.dataset.teacherId = teacher.id;
            confirmBtn.disabled = true;
            
            // Hide salary impact initially
            salaryImpactElement.classList.add("hidden");
            
            // Add input event listener
            salaryInput.addEventListener("input", () => {
                const newSalary = parseInt(salaryInput.value);
                
                if (!isNaN(newSalary) && newSalary >= 300 && newSalary <= 2000 && newSalary !== teacher.salary) {
                    confirmBtn.disabled = false;
                    
                    // Show salary impact
                    const salaryDiff = newSalary - teacher.salary;
                    const loyaltyChange = salaryDiff > 0 ? 
                        Math.ceil(salaryDiff / 100) : 
                        -Math.ceil(Math.abs(salaryDiff) / 75);
                    
                    salaryImpactElement.classList.remove("hidden");
                    salaryImpactElement.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span>Weekly Cost Change:</span>
                            <span class="${salaryDiff > 0 ? 'text-red-500' : 'text-green-500'}">${salaryDiff > 0 ? '+' : ''}$${formatCurrency(salaryDiff)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Loyalty Change:</span>
                            <span class="${loyaltyChange > 0 ? 'text-green-500' : 'text-red-500'}">${loyaltyChange > 0 ? '+' : ''}${loyaltyChange}%</span>
                        </div>
                    `;
                } else {
                    confirmBtn.disabled = true;
                    salaryImpactElement.classList.add("hidden");
                }
            });
            
            // Show modal
            modal.classList.remove("hidden");
            
            // Focus the input
            setTimeout(() => salaryInput.focus(), 100);
        }

        function showTerminationModal(teacherId) {
            const teacher = gameState.teachers.find(t => t.id === teacherId);
            
            if (!teacher) return;
            
            const modal = document.getElementById("termination-modal");
            const teacherNameElement = document.getElementById("termination-teacher-name");
            const terminationFeeElement = document.getElementById("termination-fee");
            const confirmCheckbox = document.getElementById("termination-confirm-checkbox");
            const confirmBtn = document.getElementById("confirm-termination");
            
            // Set teacher name
            teacherNameElement.textContent = teacher.name;
            
            // Calculate termination fee
            const terminationFee = teacher.salary * 2;
            terminationFeeElement.textContent = formatCurrency(terminationFee);
            
            // Set teacher ID to confirm button
            confirmBtn.dataset.teacherId = teacher.id;
            confirmBtn.disabled = true;
            confirmBtn.classList.add("opacity-50", "cursor-not-allowed");
            
            // Reset checkbox
            confirmCheckbox.checked = false;
            
            // Add checkbox event listener
            confirmCheckbox.addEventListener("change", () => {
                if (confirmCheckbox.checked) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove("opacity-50", "cursor-not-allowed");
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add("opacity-50", "cursor-not-allowed");
                }
            });
            
            // Show modal
            modal.classList.remove("hidden");
        }

        function showStudentNicknameModal(studentId, studentName) {
            const student = gameState.availableStudents.find(s => s.id === studentId);
            
            if (!student) return;
            
            const modal = document.getElementById("student-nickname-modal");
            const originalNameElement = document.getElementById("student-original-name");
            const nicknameInput = document.getElementById("student-nickname");
            const confirmBtn = document.getElementById("confirm-nickname");
            
            // Set original name
            originalNameElement.textContent = studentName;
            
            // Set current nickname if any
            nicknameInput.value = student.nickname || "";
            
            // Set student ID to confirm button
            confirmBtn.dataset.studentId = studentId;
            
            // Show modal
            modal.classList.remove("hidden");
            
            // Focus the input
            setTimeout(() => nicknameInput.focus(), 100);
        }

        function showSaveExportModal() {
            const modal = document.getElementById("save-export-modal");
            const exportDataElement = document.getElementById("export-data");
            const resetConfirmCheckbox = document.getElementById("reset-confirm-checkbox");
            const resetGameBtn = document.getElementById("reset-game-btn");
            
            // Generate export data
            const exportData = exportGameData();
            
            // Set export data
            exportDataElement.value = exportData;
            
            // Reset import data
            document.getElementById("import-data").value = "";
            
            // Reset reset checkbox
            resetConfirmCheckbox.checked = false;
            resetGameBtn.disabled = true;
            resetGameBtn.classList.add("opacity-50", "cursor-not-allowed");
            
            // Add checkbox event listener
            resetConfirmCheckbox.addEventListener("change", () => {
                if (resetConfirmCheckbox.checked) {
                    resetGameBtn.disabled = false;
                    resetGameBtn.classList.remove("opacity-50", "cursor-not-allowed");
                } else {
                    resetGameBtn.disabled = true;
                    resetGameBtn.classList.add("opacity-50", "cursor-not-allowed");
                }
            });
            
            // Show modal
            modal.classList.remove("hidden");
        }

        // Utility functions for time formatting
        function formatProgressTime(startTime, endTime) {
            const now = new Date();
            
            if (now >= endTime) {
                return "Completed";
            }
            
            const secondsRemaining = Math.floor((endTime - now) / 1000);
            
            if (secondsRemaining < 60) {
                return `${secondsRemaining}s left`;
            }
            
            const minutesRemaining = Math.floor(secondsRemaining / 60);
            
            if (minutesRemaining < 60) {
                return `${minutesRemaining}m left`;
            }
            
            const hoursRemaining = Math.floor(minutesRemaining / 60);
            const remainingMinutes = minutesRemaining % 60;
            
            if (remainingMinutes === 0) {
                return `${hoursRemaining}h left`;
            } else {
                return `${hoursRemaining}h ${remainingMinutes}m left`;
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.round(diffMs / 1000);
            const diffMin = Math.round(diffSec / 60);
            const diffHour = Math.round(diffMin / 60);
            
            if (diffSec < 60) {
                return "just now";
            } else if (diffMin < 60) {
                return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            } else if (diffHour < 24) {
                return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleString();
            }
        }

        function formatDateAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return "Today";
            } else if (diffDays === 1) {
                return "Yesterday";
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else if (diffDays < 30) {
                const diffWeeks = Math.floor(diffDays / 7);
                return `${diffWeeks} week${diffWeeks !== 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Function to check for and remove expired students
        function checkAndRemoveExpiredStudents() {
            const now = new Date();
            const expiredStudents = gameState.availableStudents.filter(student => student.deadline < now);
            
            if (expiredStudents.length > 0) {
                // Log expired students for debug purposes
                console.log(`Removing ${expiredStudents.length} expired students`);
                
                // Remove expired students
                gameState.availableStudents = gameState.availableStudents.filter(student => student.deadline >= now);
                
                // Update UI
                updateStudentsCount();
                renderStudentsList();

if (expiredStudents.length >= 1) {
            addNotification(`${expiredStudents.length} student requests have expired.`, "warning");
            // Generate replacements if list is getting low
            if (gameState.availableStudents.length < 3) {
                generateStudents(Math.min(5, expiredStudents.length + 1));
                addNotification("New student requests have been added to replace expired ones.", "success");
            }
        }
                
                // Notify user (only if significant number of students expired)
                if (expiredStudents.length >= 3) {
                    addNotification(`${expiredStudents.length} student requests have expired.`, "warning");
                }
                
                return expiredStudents.length;
            }
            
            return 0;
        }

        // Initialize UI (call when game loads/restarts)
        function initializeUI() {
            // Update all counters and displays
            updateCompanyInfo();
            updateTeachersCount();
            updateStudentsCount();
            updateActiveSessionsCount();
            updateDashboardStats();
            updateNotificationIndicator();
            updateUpgradesInfo();
            
            // Render all lists
            renderStudentsList();
            renderTeachersList();
            renderApplicantsList();
            renderActiveSessionsList();
            renderActiveTeachersList();
            renderStudentReviews();
            renderNotificationsList();
            
            // Update time
            updateCurrentTime();
            
            // Update marketing if unlocked
            if (gameState.marketing && gameState.marketing.unlocked) {
                updateMarketingContent();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved game if available
            loadSavedGame();
            
	    adjustExistingStudentDeadlines();

            // Generate initial students and applicants
            if (gameState.availableStudents.length === 0) {
                generateStudents(5);
            }
            
            if (gameState.applicants.length === 0) {
                generateApplicants(3);
            }
            
            // Initialize UI
            initializeUI();
            
            // Set up auto-save
            setupAutoSave();
            
            // Set up periodic checks for expired students (every minute)
            setInterval(checkAndRemoveExpiredStudents, 60000);
            
            // Set up time updating
            setInterval(updateCurrentTime, 1000);
            setInterval(processFatigueRecovery, 15000); // Process fatigue recovery every 15 seconds
            
            // Set up periodic check for auto-save (every minute)
            setInterval(() => {
                const now = new Date();
                
                // Check for day change
                processDayChange();
                
                // Update time display
                updateCurrentTime();

		// Process completed sessions
        	processCompletedSessions();

// Add periodic student generation (e.g., every 2 hours of game time)
    if (gameState.availableStudents.length < 5 && Math.random() < 0.2) { // 20% chance every 10 seconds
        generateStudents(1 + Math.floor(Math.random() * 3)); // Generate 1-3 students
        addNotification("New student requests have arrived!", "success");
    }
                
                // Update active sessions list
                if (gameState.activeSessions.length > 0) {
                    renderActiveSessionsList();
                }
                
                // Check and remove expired students every minute
                checkAndRemoveExpiredStudents();
updateStudentsCount(); // Ensure count updates with day changes
        renderStudentsList();  // Ensure list reflects current day                
            }, 10000);
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tab = e.target.getAttribute('data-tab');
                    
                    // Deactivate all tabs
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-primary', 'hover:dark:text-primary');
                    });
                    
                    // Activate selected tab
                    e.target.classList.add('text-primary', 'border-b-2', 'border-primary');
                    e.target.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-primary', 'hover:dark:text-primary');
                    
                    // Hide all content sections
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show selected content
                    document.getElementById(`${tab}-content`).classList.remove('hidden');
                });
            });
            
            // Notifications toggle
            document.getElementById('notifications-btn').addEventListener('click', () => {
                const notificationsPanel = document.getElementById('notifications-panel');
                
                if (notificationsPanel.classList.contains('hidden')) {
                    notificationsPanel.classList.remove('hidden');
                    renderNotificationsList();
                } else {
                    notificationsPanel.classList.add('hidden');
                }
                
                // Hide notification dot
                document.getElementById('notification-dot').classList.add('hidden');
            });
            
            document.getElementById('close-notifications').addEventListener('click', () => {
                document.getElementById('notifications-panel').classList.add('hidden');
            });
            
            // Save/Export button
            document.getElementById('save-export-btn').addEventListener('click', () => {
                showSaveExportModal();
            });
            
            // Manual save button
            document.getElementById('manual-save-btn').addEventListener('click', () => {
                if (saveGame()) {
                    addNotification("Game saved successfully.", "success");
                } else {
                    addNotification("Failed to save game.", "error");
                }
            });
            
            // Copy export data
            document.getElementById('copy-export-btn').addEventListener('click', () => {
                const exportData = document.getElementById('export-data');
                exportData.select();
                document.execCommand('copy');
                addNotification("Game data copied to clipboard.", "success");
            });
            
            // Load game
            document.getElementById('load-game-btn').addEventListener('click', () => {
                const importData = document.getElementById('import-data').value;
                
                if (!importData) {
                    addNotification("Please paste game data to import.", "error");
                    return;
                }
                
                try {
                    const success = importGameData(importData);
                    
                    if (success) {
                        addNotification("Game data loaded successfully.", "success");
                        document.getElementById('save-export-modal').classList.add('hidden');
                    } else {
                        addNotification("Failed to load game data. Invalid format.", "error");
                    }
                } catch (error) {
                    addNotification("Error loading game data: " + error.message, "error");
                }
            });
            
            // Reset game
            document.getElementById('reset-game-btn').addEventListener('click', () => {
                if (document.getElementById('reset-confirm-checkbox').checked) {
                    if (resetGame()) {
                        addNotification("Game has been reset to the beginning.", "success");
                        document.getElementById('save-export-modal').classList.add('hidden');
                    } else {
                        addNotification("Failed to reset game.", "error");
                    }
                }
            });
            
            // Teacher assignment modal
            document.getElementById('confirm-assignment').addEventListener('click', () => {
    const btn = document.getElementById('confirm-assignment');
    const studentId = parseInt(btn.dataset.studentId);
    const teacherId = parseInt(btn.dataset.teacherId);
    
    if (studentId && teacherId) {
        moveStudentToActive(studentId, teacherId);
        document.getElementById('assignment-modal').classList.add('hidden');
    }
});
            
            // Close modals
            const closeButtons = [
                { id: 'close-assignment-modal', modal: 'assignment-modal' },
                { id: 'cancel-assignment', modal: 'assignment-modal' },
                { id: 'close-teacher-detail-modal', modal: 'teacher-detail-modal' },
                { id: 'close-teacher-details', modal: 'teacher-detail-modal' },
                { id: 'close-rename-modal', modal: 'rename-teacher-modal' },
                { id: 'cancel-rename', modal: 'rename-teacher-modal' },
                { id: 'close-salary-modal', modal: 'adjust-salary-modal' },
                { id: 'cancel-salary-adjust', modal: 'adjust-salary-modal' },
                { id: 'close-company-rename-modal', modal: 'rename-company-modal' },
                { id: 'cancel-company-rename', modal: 'rename-company-modal' },
                { id: 'close-nickname-modal', modal: 'student-nickname-modal' },
                { id: 'cancel-nickname', modal: 'student-nickname-modal' },
                { id: 'close-termination-modal', modal: 'termination-modal' },
                { id: 'cancel-termination', modal: 'termination-modal' },
                { id: 'close-save-export-modal', modal: 'save-export-modal' },
	        { id: 'close-session-complete-modal', modal: 'session-complete-modal' },
        	{ id: 'session-complete-ok', modal: 'session-complete-modal' }
            ];
            
            closeButtons.forEach(button => {
                document.getElementById(button.id).addEventListener('click', () => {
                    document.getElementById(button.modal).classList.add('hidden');
                });
            });
            
            // Rename teacher
            document.getElementById('confirm-rename').addEventListener('click', () => {
                const teacherId = parseInt(document.getElementById('confirm-rename').dataset.teacherId);
                const newName = document.getElementById('new-teacher-name').value.trim();
                
                if (teacherId && newName) {
                    renameTeacher(teacherId, newName);
                    document.getElementById('rename-teacher-modal').classList.add('hidden');
                }
            });
            
            // Adjust salary
            document.getElementById('confirm-salary-adjust').addEventListener('click', () => {
                const teacherId = parseInt(document.getElementById('confirm-salary-adjust').dataset.teacherId);
                const newSalary = parseInt(document.getElementById('new-salary').value);
                
                if (teacherId && !isNaN(newSalary)) {
                    updateTeacherSalary(teacherId, newSalary);
                    document.getElementById('adjust-salary-modal').classList.add('hidden');
                }
            });
            
            // Set student nickname
            document.getElementById('confirm-nickname').addEventListener('click', () => {
                const studentId = parseInt(document.getElementById('confirm-nickname').dataset.studentId);
                const nickname = document.getElementById('student-nickname').value.trim();
                
                if (studentId) {
                    updateStudentNickname(studentId, nickname);
                    document.getElementById('student-nickname-modal').classList.add('hidden');
                }
            });
            
            // Terminate teacher
            document.getElementById('terminate-teacher-btn').addEventListener('click', () => {
                const teacherId = parseInt(document.getElementById('terminate-teacher-btn').dataset.teacherId);
                
                if (teacherId) {
                    showTerminationModal(teacherId);
                    document.getElementById('teacher-detail-modal').classList.add('hidden');
                }
            });
            
            document.getElementById('confirm-termination').addEventListener('click', () => {
                const teacherId = parseInt(document.getElementById('confirm-termination').dataset.teacherId);
                
                if (teacherId && document.getElementById('termination-confirm-checkbox').checked) {
                    terminateTeacher(teacherId);
                    document.getElementById('termination-modal').classList.add('hidden');
                }
            });
            
            // Company rename
            document.getElementById('change-name-btn').addEventListener('click', () => {
                document.getElementById('new-company-name').value = gameState.company.name;
                document.getElementById('rename-company-modal').classList.remove('hidden');
            });
            
            document.getElementById('confirm-company-rename').addEventListener('click', () => {
                const newName = document.getElementById('new-company-name').value.trim();
                
                if (newName) {
                    renameCompany(newName);
                    document.getElementById('rename-company-modal').classList.add('hidden');
                }
            });
            
            // Refresh applicants
            document.getElementById('refresh-applicants').addEventListener('click', () => {
                generateApplicants(3);
                addNotification("Refreshed teacher applicants pool.", "success");
            });
            
            // Filter and sort students
            document.getElementById('students-search').addEventListener('input', renderStudentsList);
            document.getElementById('students-filter').addEventListener('change', renderStudentsList);
            document.getElementById('students-sort').addEventListener('change', renderStudentsList);
            
            // Filter and sort teachers
            document.getElementById('teachers-search').addEventListener('input', renderTeachersList);
            document.getElementById('teachers-filter').addEventListener('change', renderTeachersList);
            document.getElementById('teachers-sort').addEventListener('change', renderTeachersList);
            
            // Change earnings period
            document.getElementById('earnings-period').addEventListener('change', updateEarningsChart);
            
            // Upgrade session quota
            document.getElementById('upgrade-quota-btn').addEventListener('click', () => {
                upgradeSessionQuota();
            });
            
            document.getElementById('quota-upgrade-btn').addEventListener('click', () => {
                upgradeSessionQuota();
            });
            
            // Upgrade teacher lounge
            document.getElementById('upgrade-lounge-btn').addEventListener('click', () => {
                upgradeTeacherLounge();
            });
            
            // Upgrade office
            document.getElementById('upgrade-office-btn').addEventListener('click', () => {
                upgradeOffice();
            });
            
            // Host workshop
            document.getElementById('host-workshop-btn').addEventListener('click', () => {
                hostWorkshop();
            });
            
            // Unlock marketing
            document.getElementById('unlock-marketing-btn').addEventListener('click', () => {
                unlockMarketing();
            });
            
            // Start marketing campaign
            document.querySelectorAll('.start-campaign-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const campaignType = e.target.getAttribute('data-campaign');
                    startMarketingCampaign(campaignType);
                });
            });
            
            // Seek investment
            document.getElementById('seek-investment-btn').addEventListener('click', () => {
                if (gameState.company.reputation >= 4.0) {
                    seekInvestment();
                } else {
                    addNotification("Company reputation too low to attract investors. Need 4.0+ reputation.", "error");
                }
            });
        });
    </script>
</body>
</html>
